{"id":8,"date":"2017-08-25T10:26:45","date_gmt":"2017-08-25T10:26:45","guid":{"rendered":"https:\/\/opnsec.com\/?p=8"},"modified":"2021-07-30T20:07:09","modified_gmt":"2021-07-30T20:07:09","slug":"advanced-flash-vulnerabilities-in-youtube","status":"publish","type":"post","link":"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube\/","title":{"rendered":"Advanced Flash Vulnerabilities in Youtube &#8211; Part 1"},"content":{"rendered":"<h3>Why Flash Security still matters?<\/h3>\n<p><img loading=\"lazy\" class=\"alignnone wp-image-147 size-medium\" style=\"display: none;\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Youtube-Flash-Api-1.png\" alt=\"\" width=\"1\" height=\"1\" \/>Flash is still an active threat. In 2017, I reported Flash vulnerabilities to Facebook, Youtube, WordPress, Yahoo, Paypal and Stripe. Over the last 3 years, I reported more than 50 Flash vulnerabilities to Bug Bounty programs. And there are many more I didn&#8217;t have the time to report or that weren&#8217;t fixed after I reported it.<\/p>\n<p><img loading=\"lazy\" class=\"size-medium wp-image-73 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/1uureg-300x184.jpg\" alt=\"\" width=\"300\" height=\"184\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/1uureg-300x184.jpg 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/1uureg.jpg 450w\" sizes=\"(max-width: 300px) 100vw, 300px\" \/><br \/>\nIn addition, Flash has been replaced by new javascript\/html5 features. These features introduce complexity and new kind of vulnerabilities like bad CORS implementation, DOM XSSes triggered by postMessage or XHR requests, active mixed content&#8230; Learning from Flash mistakes can help design and implement more secure javascript applications. The new Youtube html5 Api is mostly a porting of the Youtube Flash Api to javascript, making it interesting to study. In fact, I was able to find XSSes in the Youtube html5 Api using my knowledge of the Flash Api.<br \/>\nI&#8217;ll explain some advanced Flash vulnerabilities I found in Youtube Flash Api and in the process I will draw a parallel with html\/javascript security. This is quite technical so feel free to comment or to tweet me (<a href=\"https:\/\/twitter.com\/opnsec\" target=\"_blank\" rel=\"noopener noreferrer\">@opnsec<\/a>) if something is not clear or if you want to add something. You can also read more about Flash security model <a href=\"http:\/\/www.senocular.com\/flash\/tutorials\/contentdomains\/\" target=\"_blank\" rel=\"noopener noreferrer\">here<\/a>.<\/p>\n<h2>Reverse engineering Youtube Flash Api<\/h2>\n<p>Youtube Flash Api allows developers to embed a Youtube video in an external website.<br \/>\nHere is the workflow of the Api:<\/p>\n<p><a href=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme1.svg\" target=\"_blank\" rel=\"noopener noreferrer\"><img loading=\"lazy\" class=\"aligncenter wp-image-11\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme1.svg\" alt=\"\" width=\"982\" height=\"468\" \/><\/a><\/p>\n<p>The entry point, Youtube Wrapper, is a Flash file located at youtube.com\/v\/[VIDEO_ID], it is just a wrapper between the HTML page and the Main App.<br \/>\nThe Main Application is a large flash file of about 100k LoC and is located in a sandboxed domain s.ytimg.com.<br \/>\nThe Modules handle optional functions like subtitles or advertisements. They are not stand-alone Flash files and can only be loaded by the Main App.<\/p>\n<p>In addition there is a Flash to Javascript Api that allows the html page to send commands to the Youtube Api like play(), pause(), etc&#8230; Flash files will also perform &#8220;ajax style&#8221; cross-domain requests to load configuration files and video data.<\/p>\n<h2>I. User info leakage<\/h2>\n<p>Let&#8217;s start with a simple vulnerability. Here is a simplified version of Youtube Wrapper code in Flash ActionScript3 (AS3) :<\/p>\n<pre><code >public class YoutubeWrapper extends Sprite{<\/p>\n<p>private var user_name = \"The Victim\";<br \/>\nprivate var user_picture = \"https:\/\/googleusercontent.com\/...\/victim_photo.jpg\";<br \/>\nprivate var appLoader = new Loader();<\/p>\n<p>public function YoutubeWrapper(){<br \/>\n\/\/ allow external javascript\/Flash files to access its public properties<br \/>\nSecurity.allowDomain(\"*\");<br \/>\n\/\/ load the Main App<br \/>\nthis.appLoader .load(new URLRequest(\"https:\/\/s.ytimg.com\/...\/watch_as3.swf\");<br \/>\n\/\/ add as child of display container<br \/>\nthis.addChild(this.appLoader );<br \/>\n\/\/ loaderInfo.sharedEvents Api<br \/>\nthis.loader.contentLoaderInfo.sharedEvents<br \/>\n.addEventListener(\"REQUEST_USERINFO\", this.onRequestUserinfo);<br \/>\n}<br \/>\nprivate function onRequestUserinfo(event:Event){<br \/>\n\/\/ write the user info into the event.data property<br \/>\n\/\/ which is accessible to the sharedEvents caller<br \/>\nevent.data.user_name = this.user_name;<br \/>\nevent.data.user_image = this.user_image;<br \/>\n}<br \/>\n}<\/code><\/pre>\n<p>Youtube Wrapper is generated on the fly and its property &#8220;user_name&#8221; contains the Google user name (if he is connected to Google). The property &#8220;user_picture&#8221; contains the link to the user profile picture. In this bug, the attacker will steal these values.<\/p>\n<p>Youtube Wrapper can be loaded from the developer own Flash file (let&#8217;s call it Evil Wrapper). In that case, they both executes in a different Flash security sandbox.<\/p>\n<blockquote><p>Loading an external Flash file in Flash is a little bit similar to loading an &lt;iframe&gt; in html. If the iframe is from a different origin than its parent, they cannot access each other properties due to the Same-Origin Policy (SOP)<\/p><\/blockquote>\n<p>Youtube Wrapper contains the code <a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/system\/Security.html#allowDomain()\" target=\"_blank\" rel=\"noopener noreferrer\">Security.allowDomain(&#8220;*&#8221;)<\/a> to allow javascript on the hosting webpage to send commands to the Flash app like play(), pause(),etc&#8230; This also means that Evil Wrapper can access any public property of Youtube Wrapper as if it was in the same Security sandbox. However it cannot access private properties.<\/p>\n<p>The user_name property is private so Evil Wrapper cannot access it.<\/p>\n<p>Flash also provides an Api for communication between a Loader and a loaded file using <a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/display\/LoaderInfo.html#sharedEvents\" target=\"_blank\" rel=\"noopener noreferrer\">loaderInfo.sharedEvents<\/a>. Youtube Wrapper uses this api to communicate with the Main App. When the Main App dispatches an event to the sharedEvents Api, the Youtube Wrapper receives the event and send back the user info using the event.data property.<br \/>\nloaderInfo.sharedEvents is not only accessible to the loader and the loaded files, but also to any Flash file that has a reference to this loaderInfo object.<\/p>\n<blockquote><p>This is similar to the javascript <a href=\"https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/Window\/postMessage\" target=\"_blank\" rel=\"noopener noreferrer\">postMessage Api <\/a>which allows communication between cross-domain iframes. The postMessage Api is accessible not only to the iframe and its parent but also to any other window that has a reference to the iframe or the parent. Any arbitrary domain can access these references using window.open and window.frames, which are not restricted by the SOP.<\/p><\/blockquote>\n<p>If Evil loader can access this particular loaderInfo object it will be able to send an event to the Youtube Wrapper and steal the user info.<br \/>\nloaderInfo is a property of appLoader which is a private property of the Youtube Wrapper, so Evil Wrapper cannot access it.<\/p>\n<p>However, when using a Loader, if you want to display the loaded file, you have to add it as a child of the Display Container. This is usually done using<br \/>\nthis.<a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/display\/DisplayObjectContainer.html#addChild()\" target=\"_blank\" rel=\"noopener noreferrer\">addChild<\/a>(this.loader); and this is exactly what the Youtube Wrapper does.<br \/>\nThe thing is that the Youtube Wrapper also have a built-in public method <a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/display\/DisplayObjectContainer.html#getChildAt()\" target=\"_blank\" rel=\"noopener noreferrer\">getChildAt<\/a>() that will return the children of the Youtube Wrapper. This means that Evil Wrapper can call YoutubeWrapper.getChildAt(0) which will return the loader object, bypassing the privacy of the loader property.<\/p>\n<blockquote><p>Setting a property as &#8220;private&#8221; is called <a href=\"https:\/\/en.wikipedia.org\/wiki\/Encapsulation_(computer_programming)\" target=\"_blank\" rel=\"noopener noreferrer\">encapsulation<\/a>. However, only the reference is private, not the object the reference points to.<\/p><\/blockquote>\n<p>From there Evil Wrapper can access YoutubeWrapper.getChildAt(0).loaderInfo.sharedEvents which is the interface between Youtube Wrapper and the Main App. Evil Wrapper can send an event to the Youtube Wrapper, the Youtube Wrapper will provide the user info in the event.data property and Evil Wrapper can then read the event.data value.<br \/>\nProof of Concept :<\/p>\n<p>Evil Wrapper code was like this<\/p>\n<pre><code >var loader = new Loader();<br \/>\n\/\/ Load the Youtube Wrapper<br \/>\nloader.load(new URLRequest(\"https:\/\/www.youtube.com\/v\/[VIDEO_ID]\"));<br \/>\nvar youtubeWrapper = loader.content;<br \/>\n\/\/ Access the Youtube Wrapper appLoader object<br \/>\nvar appLoader = youtubeWrapper.getChildAt(0);<br \/>\n\/\/ Access the loaderInfo.sharedEvents of appLoader<br \/>\nvar LeakingSharedEvents = appLoader.contentLoaderInfo.sharedEvents;<\/p>\n<p>\/\/ Prepare the event to send to Youtube Wrapper<br \/>\nvar leakEvent = new Event(\"Request_username\");<br \/>\nleakEvent.data = new Object();<br \/>\n\/\/ Send the leakEvent to the LeakingSharedEvents<br \/>\nLeakingSharedEvents.dispatchEvent(leakEvent);<\/p>\n<p>\/\/ The username is now accessible in the event.data property<br \/>\ntrace(leakEvent.data.user_name);<br \/>\ntrace(leakEvent.data.user_picture);<\/code><\/pre>\n<p>POC workflow :<\/p>\n<p><img loading=\"lazy\" class=\"wp-image-40 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme2.svg\" alt=\"\" width=\"800\" height=\"287\" \/><br \/>\nAttack scenario:<br \/>\nPrerequisite: The victim is logged in Google and have Flash player<br \/>\n(1) The victim visits the attacker webpage evil.com\/evil.html which contains a Flash object evil.com\/evil.swf<br \/>\n(2) evil.swf loads Youtube wrapper (https:\/\/www.youtube.com\/v\/[VIDEO_ID]) and retrieves the user Google username (4-5-6)<br \/>\nevil.com now knows the username of it&#8217;s visitors. In addition, as the profile picture link is unique, it is possible to uniquely identify the user&#8217;s Google account.<\/p>\n<p>Impact:<br \/>\nAny website could use this to know the identity of it&#8217;s users, if they are connected to Google. Imagine how you would feel if you visit a random website and this website displays your name and your picture!<\/p>\n<p>Mitigation:<br \/>\nTo resolve this issue, Youtube Wrapper stopped writing the user info in the event.data property and instead sends it directly to the Main App. That way even if Evil Wrapper sends an event to Youtube Wrapper, it wouldn&#8217;t receive the user info as it would be directly sent to the Main App.<\/p>\n<p>Timeline:<br \/>\n08\/27\/2015 &#8211; reported to Google VRP<br \/>\n09\/09\/2015 &#8211; issue fixed and reward <img loading=\"lazy\" class=\"alignnone wp-image-44 size-full\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/1-star.png\" alt=\"\" width=\"60\" height=\"14\" \/><br \/>\nThis was a simple bug and I hope it helps you understand the basic challenges here. You can read about another bug where we actually execute arbitrary Flash code in youtube.com in <a href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube-part-2\/\"><strong>Part 2<\/strong><\/a>.<\/p>\n\n<div class=\"twitter-share\"><a href=\"https:\/\/twitter.com\/intent\/tweet?via=opnsec\" class=\"twitter-share-button\">Tweet<\/a><\/div>\n","protected":false},"excerpt":{"rendered":"<p>Why Flash Security still matters? Flash is still an active threat. In 2017, I reported Flash vulnerabilities to Facebook, Youtube, WordPress, Yahoo, Paypal and Stripe. Over the last 3 years, I reported more than 50 Flash vulnerabilities to Bug Bounty programs. And there are many more I didn&#8217;t have the time to report or that&hellip; <a class=\"read-more\" href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube\/\">Read More<\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":""},"categories":[2],"tags":[3,5,4],"jetpack_featured_media_url":"","_links":{"self":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/8"}],"collection":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/comments?post=8"}],"version-history":[{"count":82,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/8\/revisions"}],"predecessor-version":[{"id":411,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/8\/revisions\/411"}],"wp:attachment":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/media?parent=8"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/categories?post=8"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/tags?post=8"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}