{"id":64,"date":"2017-08-30T12:04:52","date_gmt":"2017-08-30T12:04:52","guid":{"rendered":"https:\/\/opnsec.com\/?p=64"},"modified":"2021-07-30T20:07:09","modified_gmt":"2021-07-30T20:07:09","slug":"advanced-flash-vulnerabilities-in-youtube-part-3","status":"publish","type":"post","link":"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube-part-3\/","title":{"rendered":"Advanced Flash Vulnerabilities in Youtube &#8211; Part 3"},"content":{"rendered":"<h3>III. XSF via loaderinfo.url redefinition<\/h3>\n<p><img loading=\"lazy\" class=\"alignnone size-medium wp-image-150\" style=\"display: none;\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/s.ytimg_.com-POC-300x121.png\" alt=\"\" width=\"1\" height=\"1\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/s.ytimg_.com-POC-300x121.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/s.ytimg_.com-POC-150x150.png 150w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/s.ytimg_.com-POC-768x310.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/s.ytimg_.com-POC-1024x414.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/s.ytimg_.com-POC-640x360.png 640w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/s.ytimg_.com-POC.png 1186w\" sizes=\"(max-width: 1px) 100vw, 1px\" \/>Let&#8217;s have a look at how the Main App loads the Modules :<\/p>\n<p><a href=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme7.svg\"><img loading=\"lazy\" class=\"wp-image-66 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme7.svg\" alt=\"\" width=\"907\" height=\"217\" \/><\/a><\/p>\n<p>The url of the module is dynamically generated by the main app by using it&#8217;s own url (2) and replacing the filename (watch_as3.swf) by the module filename (subtitles.swf) (3). This allows to handle multiple versions on the Main App, each one with it&#8217;s own Modules location.<\/p>\n<p>To find it&#8217;s own url, the main app uses the <a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/display\/LoaderInfo.html#url\" target=\"_blank\" rel=\"noopener noreferrer\">loaderinfo.url<\/a> property of appLoader.<\/p>\n<blockquote><p>Since appLoader is similar to an &lt;iframe&gt; in html, appLoader.loaderInfo.url is similar to the &#8220;src&#8221; attribute of the iframe.<\/p><\/blockquote>\n<p>In flash a Loader can load multiple swf files while in html an iframe can only load one window at a time<\/p>\n<p>This means that if appLoader first loads the Main App and then immediately loads another Flash file the loaderinfo.url property of the Main app will not reflect the url of the Main App but instead the url of the other loaded flash file.<br \/>\nPOC workflow<\/p>\n<p><a href=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme5.svg\"><img loading=\"lazy\" class=\"wp-image-68 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme5.svg\" alt=\"\" width=\"818\" height=\"314\" \/><\/a><\/p>\n<p>We removed Youtube Wrapper and replaced it with Evil Wrapper. Evil Wrapper will first load the Main App (1), and then immediately load another file (Noop.swf) with the same Loader appLoader (2). When the Main app will try to load a Module, it will get the appLoader url value (3) (evil.com\/Noop.swf), replace the filename with the module name (evil.com\/subtitles.swf) and load an arbitrary Flash file into it own Flash security sandbox (4).<\/p>\n<p>From there Evil Module will be in the Main App Security Sandbox and will appear to be located at s.ytimg.com\/[[IMPORT]]\/evil.com\/subtitles.swf. However, s.ytimg.com is a sandboxed domain which doesn&#8217;t have any cookie, CSRF token or webpage to exploit.<\/p>\n<p>In <a href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube-part-2\/\">part 2<\/a> I introduced URLLoader, which is similar to XHR. You can make cross-domain requests with URLLoader if the remote server has a crossdomain.xml file allowing &#8220;s.ytimg.com&#8221;<\/p>\n<blockquote><p>crossdomain.xml mechanism is similar to CORS headers for XHR cross-domain requests in javascript<\/p><\/blockquote>\n<p>The good news is that <a href=\"https:\/\/www.youtube.com\/crossdomain.xml\" target=\"_blank\" rel=\"noopener noreferrer\">https:\/\/www.youtube.com\/crossdomain.xml<\/a> does allow https:\/\/s.ytimg.com\/. Even more, <a href=\"https:\/\/drive.google.com\/crossdomain.xml\" target=\"_blank\" rel=\"noopener noreferrer\">https:\/\/drive.google.com\/crossdomain.xml<\/a>, <a href=\"https:\/\/docs.google.com\/crossdomain.xml\" target=\"_blank\" rel=\"noopener noreferrer\">https:\/\/docs.google.com\/crossdomain.xml<\/a> and <a href=\"https:\/\/clients6.google.com\/crossdomain.xml\" target=\"_blank\" rel=\"noopener noreferrer\">other google domains <\/a>also allow https:\/\/s.ytimg.com\/.<\/p>\n<p>This means that Evil Module can send requests to any URL at youtube.com, drive.google.com and docs.google.com (including POST requests and custom headers) and read the response source code (5).<br \/>\nAttack scenario:<br \/>\n1. The victim is logged in Youtube or Google Drive and has Flash player<br \/>\n2. The victim visits the attacker evil.com\/evil.html page which contains a Flash object evil.com\/evil.swf<br \/>\n3. The attacker has control over the victim&#8217;s Youtube, Google Drive and Google Docs accounts<\/p>\n<p>Impact:<br \/>\nThe attacker can steal private information, CSRF tokens and perform any CSRF action on these domains. A very nasty exploit could steal and delete all the victim Google Drive files and then post the POC url on Youtube comments from the victim account to spread the exploit. I won&#8217;t provide such POC (I would like to safely return to DefCon next year&#8230;) but it would only take about 20 LOC to build it!<\/p>\n<p>Timeline:<br \/>\n09\/11\/2015 &#8211; reported to Google VRP<br \/>\n09\/16\/2015 &#8211; &#8220;Nice catch&#8221; from Google<br \/>\n09\/25\/2015 &#8211; Temporary mitigation and reward<img loading=\"lazy\" class=\"alignnone size-full wp-image-70\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/3-stars.png\" alt=\"\" width=\"60\" height=\"14\" \/><br \/>\n10\/14\/2015 &#8211; Issue fixed and verified<\/p>\n<p>Conclusion:<br \/>\nWhen using a sandboxed domain for hosting untrusted applications, like s.ytimg.com, you should always make sure that the sandboxed domain has no privilege on sensitive domains, like crossdomain.xml files, CORS, framing or CSP.<\/p>\n<p>[<strong>UPDATED<\/strong>] <strong><a href=\"https:\/\/opnsec.com\/2017\/09\/advanced-flash-vulnerabilities-in-youtube-part-4\/\">Part 4 <\/a><\/strong>is now online with 3 Flash based XSS on Youtube!<\/p>\n<p>You can also see a live Flash based XSS on twitter <a href=\"https:\/\/opnsec.com\/twitter\/photo.html\" target=\"_blank\" rel=\"noopener noreferrer\">here<\/a><\/p>\n\n<div class=\"twitter-share\"><a href=\"https:\/\/twitter.com\/intent\/tweet?via=opnsec\" class=\"twitter-share-button\">Tweet<\/a><\/div>\n","protected":false},"excerpt":{"rendered":"<p>III. XSF via loaderinfo.url redefinition Let&#8217;s have a look at how the Main App loads the Modules : The url of the module is dynamically generated by the main app by using it&#8217;s own url (2) and replacing the filename (watch_as3.swf) by the module filename (subtitles.swf) (3). This allows to handle multiple versions on the&hellip; <a class=\"read-more\" href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube-part-3\/\">Read More<\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":""},"categories":[2],"tags":[3,5,4],"jetpack_featured_media_url":"","_links":{"self":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/64"}],"collection":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/comments?post=64"}],"version-history":[{"count":26,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/64\/revisions"}],"predecessor-version":[{"id":374,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/64\/revisions\/374"}],"wp:attachment":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/media?parent=64"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/categories?post=64"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/tags?post=64"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}