{"id":382,"date":"2020-05-03T06:04:09","date_gmt":"2020-05-03T06:04:09","guid":{"rendered":"https:\/\/opnsec.com\/?p=382"},"modified":"2021-07-30T20:07:09","modified_gmt":"2021-07-30T20:07:09","slug":"dom-xss-in-gmail-with-a-little-help-from-chrome","status":"publish","type":"post","link":"https:\/\/opnsec.com\/2020\/05\/dom-xss-in-gmail-with-a-little-help-from-chrome\/","title":{"rendered":"DOM XSS in Gmail with a little help from Chrome"},"content":{"rendered":"<p>How to use browser features to help find DOM XSS.<\/p>\n<h3>The invisible Messages of Gmail<\/h3>\n<p>Last year, I looked for DOM XSS in Gmail website. Instead of using url params or the emails themselves as the source of the attack, I decided to use the much more discreet yet ubiquitous <a href=\"https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/Window\/postMessage\" target=\"_blank\" rel=\"noopener noreferrer\">postMessage<\/a> api.\u00a0 At first glance, the Gmail inbox seems a simple webpage, but if you go through the looking glass, it&#8217;s actually a dozen of different webpages (or iframes) communicating between each others.<\/p>\n<p><img loading=\"lazy\" class=\"alignnone size-large wp-image-384\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/iframes-1024x547.png\" alt=\"\" width=\"1024\" height=\"547\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/iframes-1024x547.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/iframes-300x160.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/iframes-768x410.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/iframes-1536x821.png 1536w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/iframes.png 1920w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/p>\n<p>My first task was to make the cross-frames messages visible. This is not a native feature in DevTools yet. Instead, you can use this simple <a href=\"https:\/\/github.com\/opnsec\/postMessage-logger\" target=\"_blank\" rel=\"noopener noreferrer\">postMessage logger extension<\/a>. After reloading, the console is now overwhelmed with frame to frame messages going back and forth.<\/p>\n<p><img loading=\"lazy\" class=\"alignnone size-large wp-image-385\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/postmessage-1024x547.png\" alt=\"\" width=\"1024\" height=\"547\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/postmessage-1024x547.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/postmessage-300x160.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/postmessage-768x410.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/postmessage-1536x821.png 1536w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/postmessage.png 1600w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/p>\n<blockquote><p>Each message has a <strong>target<\/strong> (the frame which receives the message), a <strong>source<\/strong> (the frame which sent the message), an <strong>origin<\/strong> (the domain of the source) and the <strong>data<\/strong>, which can be a string or a JSON object (or any kind of object that <a href=\"https:\/\/developer.mozilla.org\/en-US\/docs\/Web\/API\/Web_Workers_API\/Structured_clone_algorithm\">will be cloned<\/a> in the process). Messages can be sent by any frame to another, even from different domain and even from different tab if the source has a reference to the target, with window.opener, window.open() and window.frames.<\/p><\/blockquote>\n<p>The target receives the message using <pre><code ><span class=\"pl-en\">addEventListener<\/span><span class=\"pl-kos\">(<\/span><span class=\"pl-s\">\"message\", function(message){\/* handle message here *\/})<\/code><\/pre> like in the extension.<\/span><\/p>\n<p>If there are too many messages, you can customize the extension to filter messages by any of their property. I was looking for interesting messages and one message in particular contained an url in the data:<\/p>\n<p><img loading=\"lazy\" class=\"alignnone size-large wp-image-387\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/frame-1024x340.png\" alt=\"\" width=\"1024\" height=\"340\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/frame-1024x340.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/frame-300x100.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/frame-768x255.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/frame.png 1182w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/p>\n<p>This message is sent by &#8220;hangouts.google.com&#8221; to &#8220;mail.google.com&#8221; . Not only is there a url in the message data, but the url contains the word &#8220;frame&#8221;. interesting&#8230;<\/p>\n<h3>The browser Toolbox<\/h3>\n<p>I went to the network tab of DevTools and filtered the requests by type &#8220;doc&#8221; which means &#8220;top window url and iframes src&#8221;. The same url was there:<\/p>\n<p><img loading=\"lazy\" class=\"alignnone size-large wp-image-389\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/network-1024x480.png\" alt=\"\" width=\"1024\" height=\"480\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/network-1024x480.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/network-300x141.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/network-768x360.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/network.png 1155w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/p>\n<p>I could also confirm that the request referrer was &#8220;mail.google.com&#8221; which was a good sign since it&#8217;s the domain that received the Message. The value in red circle is the initiator of the request, the JS code that loaded the iframe. You can click on it and it brings you directly to the corresponding code in the source tab. Unminify the code, set a breakpoint, reload and the breakpoint is hit:<\/p>\n<p><img loading=\"lazy\" class=\"alignnone size-large wp-image-390\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/debug-1024x441.png\" alt=\"\" width=\"1024\" height=\"441\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/debug-1024x441.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/debug-300x129.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/debug-768x331.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/debug.png 1533w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/p>\n<p>And voila! The function that triggers the request is appendChild(). This is pretty much all we can understand from the code which is unreadable. But with the magic of the debugger we can confirm that the argument contains an iframe with the src set to the url. If you click on the functions in the Call Stack on the right, you can navigate through the &#8220;control flow&#8221; of the program and understand its logic.<\/p>\n<p>For example, here is how the message is received by the frame:<\/p>\n<p><img loading=\"lazy\" class=\"alignnone size-full wp-image-391\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/listener.png\" alt=\"\" width=\"766\" height=\"217\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/listener.png 766w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/listener-300x85.png 300w\" sizes=\"(max-width: 766px) 100vw, 766px\" \/><\/p>\n<p>You can even see the code where the source of the message sent it:<\/p>\n<p><img loading=\"lazy\" class=\"alignnone size-full wp-image-392\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/post.png\" alt=\"\" width=\"1013\" height=\"319\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/post.png 1013w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/post-300x94.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/post-768x242.png 768w\" sizes=\"(max-width: 1013px) 100vw, 1013px\" \/><\/p>\n<blockquote><p>There are dozens of functions between the listener and the loading of the url, across multiple files and thousands of lines of code. It is not uncommon that the browser freezes, breaks or skips breakpoint when you debug such heavy webpages, it&#8217;s a matter of trial and error! \ud83d\ude09<\/p><\/blockquote>\n<p>I tried to send a message to the frame from the console with the same data but with &#8220;javascript:alert(1)&#8221; instead of the url. I didn&#8217;t got an alertbox, but a CSP error message.<\/p>\n<p><img loading=\"lazy\" class=\"alignnone size-large wp-image-393\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/csp-1024x52.png\" alt=\"\" width=\"1024\" height=\"52\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/csp-1024x52.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/csp-300x15.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/csp-768x39.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/csp-1536x79.png 1536w, https:\/\/opnsec.com\/wp-content\/uploads\/2020\/05\/csp.png 1779w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/p>\n<p>Thankfully, this CSP rule wasn&#8217;t enforced by IE11 and Edge (at the time) so I was able to trigger the alertbox on those browsers. There was no check on the origin of the message. A simple attack scenario is to start from the attacker webpage, open a new tab to Gmail and inject the payload in the Gmail tab using postMessage. The Gmail tab loads the javascript iframe and the attacker has arbitrary code execution on the victim&#8217;s Gmail page, which means it can read and send emails, change password of accounts registered to this email etc&#8230;<\/p>\n<h3>The random Channel Name<\/h3>\n<p>There was still one issue: with so much communication between so many frames, it is easy to get confused, so messages usually have a channel name. The name is a random 6 char generated by &#8220;mail.google.com&#8221; and transmitted in the first message to &#8220;hangouts.google.com&#8221;. In all following messages that it receives, &#8220;hangouts.google.com&#8221; checks if it contains the correct channel name, and if not it doesn&#8217;t process the message.<\/p>\n<p>The attacker doesn&#8217;t know the channel name, and 6 alphanumeric is too much possibilities to try all.<br \/>\nThe random generator is &#8220;Math.random()&#8221; which is not secure and <a href=\"http:\/\/ifsec.blogspot.com\/2012\/09\/of-html5-security-cross-domain.html\" target=\"_blank\" rel=\"noopener noreferrer\">has been exploited<\/a> in the past by a Google engineer to find an XSS in Facebook! \ud83d\ude42 However the technique required the state of the random generator to be shared between cross-domain tabs which is not the case anymore.<br \/>\nThe third solution is to load an iframe controlled by the attacker in the hierarchy of frames in the Gmail tab. Because of the way cross-domain redirection of iframes works in the browser, the fact that Gmail X-Frame-Options header is &#8220;SAMEORIGIN&#8221; and that the messages were sent with the argument targetOrigin &#8220;*&#8221;, it would then be possible to intercept the channel name and execute the XSS.<\/p>\n<h3>Conclusion<\/h3>\n<p>I couldn&#8217;t find an easy way to load an iframe inside Gmail, but with all this I was confident enough to send a report to Google VRP and after a few days I received the &#8220;Nice Catch&#8221; answer and reward. Google fixed it by adding check on the origin of the message containing the url. The XSS doesn&#8217;t work anymore, but the message is still sent if you want to check.<\/p>\n<p>Browsers have all the cool features to navigate complex code, and for the features that are still missing, you can build you own extensions easily. With that, good hunting! \ud83d\ude42<\/p>\n<p>&nbsp;<\/p>\n\n<div class=\"twitter-share\"><a href=\"https:\/\/twitter.com\/intent\/tweet?via=opnsec\" class=\"twitter-share-button\">Tweet<\/a><\/div>\n","protected":false},"excerpt":{"rendered":"<p>How to use browser features to help find DOM XSS. The invisible Messages of Gmail Last year, I looked for DOM XSS in Gmail website. Instead of using url params or the emails themselves as the source of the attack, I decided to use the much more discreet yet ubiquitous postMessage api.\u00a0 At first glance,&hellip; <a class=\"read-more\" href=\"https:\/\/opnsec.com\/2020\/05\/dom-xss-in-gmail-with-a-little-help-from-chrome\/\">Read More<\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":""},"categories":[9],"tags":[],"jetpack_featured_media_url":"","_links":{"self":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/382"}],"collection":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/comments?post=382"}],"version-history":[{"count":21,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/382\/revisions"}],"predecessor-version":[{"id":415,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/382\/revisions\/415"}],"wp:attachment":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/media?parent=382"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/categories?post=382"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/tags?post=382"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}